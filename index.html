<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Capacitaci√≥n ALPACEL | Agenda + Reporte</title>
  <meta name="description" content="Calendario semanal editable + reporte de indicadores con semaforizaci√≥n + checklist + exportar a Excel." />
  <style>
    :root{
      --bg0:#1b0c05; --bg1:#2a1207;
      --card:#2f1609cc; --card2:#351a0bcc;
      --stroke:#ffffff1f;
      --text:#fff7ef; --muted:#ffd9bfcc;
      --accent:#ff7a18; --accent2:#ffb24a;
      --good:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, #ff8a2a22 0%, transparent 60%),
        radial-gradient(1000px 700px at 85% 20%, #ffcf6a1e 0%, transparent 55%),
        radial-gradient(900px 600px at 40% 95%, #ff4d1a14 0%, transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, #1b0c05ee, #1b0c0599);
      border-bottom:1px solid var(--stroke);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(255,122,24,.25);
      display:grid;place-items:center;border:1px solid #ffffff2a;
      font-weight:900;color:#2a1207;user-select:none;
    }
    .title h1{margin:0;font-size:18px;letter-spacing:.2px}
    .title p{margin:2px 0 0;color:var(--muted);font-size:12.5px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{
      appearance:none;border:1px solid #ffffff26;
      background: linear-gradient(180deg, #3a1c0ddd, #2a1207dd);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;box-shadow: 0 10px 22px rgba(0,0,0,.25);
      transition: transform .08s ease, border-color .2s ease, filter .2s ease;
      font-weight:800;font-size:13px;
    }
    button:hover{transform: translateY(-1px); border-color:#ffffff3a; filter:saturate(1.1)}
    button:active{transform: translateY(0px) scale(.99)}
    .btnAccent{background: linear-gradient(135deg, var(--accent), var(--accent2)); color:#2a1207;border-color:#ffffff3a;}
    .grid{display:grid;grid-template-columns: 1.25fr .85fr;gap:14px;padding:16px;}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}
    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding:14px 14px 10px;border-bottom:1px solid var(--stroke);
      display:flex;justify-content:space-between;align-items:flex-end;gap:10px;flex-wrap:wrap;
    }
    .cardHeader h2{margin:0;font-size:15px;letter-spacing:.2px}
    .cardHeader .sub{color:var(--muted);font-size:12.5px;margin-top:4px}
    .cardBody{padding:14px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid #ffffff22;color:var(--muted);font-size:12px;background:#00000024;user-select:none;white-space:nowrap;
    }
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;min-width:180px;flex:1;}
    label{font-size:12px;color:var(--muted)}
    input, textarea{
      width:100%;background:#00000022;border:1px solid #ffffff22;color:var(--text);
      border-radius:14px;padding:10px 10px;outline:none;font-size:13px;
    }
    textarea{min-height:84px;resize:vertical}
    input:focus, textarea:focus{border-color:#ffffff44}
    table{
      width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;
      border:1px solid #ffffff22;border-radius:16px;background:#00000016;
    }
    th, td{
      padding:10px 10px;border-bottom:1px solid #ffffff18;border-right:1px solid #ffffff12;
      vertical-align:top;font-size:13px;
    }
    th{color:#ffe7d6;font-size:12px;text-transform:uppercase;letter-spacing:.6px;background:#00000022}
    tr:last-child td{border-bottom:none}
    td:last-child, th:last-child{border-right:none}
    .cellInput{width:100%;background:transparent;border:none;padding:0;color:var(--text);outline:none;font-size:13px;}
    .cellInput::placeholder{color:#ffffff55}
    .mini{font-size:12px;color:var(--muted)}
    .sema{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid #ffffff22;background:#00000022;font-weight:900;font-size:12px;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.good{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .muted{color:var(--muted)}
    .split{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media (max-width: 680px){.split{grid-template-columns:1fr}}
    .checklist{display:grid;gap:10px;}
    .checkItem{
      display:flex;align-items:flex-start;gap:10px;padding:10px 12px;
      border:1px solid #ffffff1f;border-radius:16px;background:#00000018;
    }
    .checkItem input{width:18px;height:18px;margin-top:2px}
    .checkItem .txt b{display:block}
    .footerSig{
      margin-top:12px;padding-top:12px;border-top:1px dashed #ffffff2a;
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12.5px;
    }
    .printOnly{display:none}
    @media print{
      header, .noPrint{display:none !important}
      body{background:#fff;color:#111}
      .card{box-shadow:none;border:1px solid #ddd;background:#fff}
      .cardHeader{border-bottom:1px solid #ddd}
      th{background:#f3f3f3;color:#111}
      input, textarea{border:1px solid #ddd;color:#111;background:#fff}
      .cellInput{color:#111}
      .sema{border:1px solid #ddd;background:#fff;color:#111}
      .printOnly{display:block}
      .wrap{max-width:none}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap topbar">
    <div class="brand">
      <div class="logo">A</div>
      <div class="title">
        <h1>Capacitaci√≥n ALPACEL ‚Äî Agenda + Reporte</h1>
        <p>Calendario semanal, reporte con sem√°foro, indicadores individuales, checklist y exportar a ‚ÄúExcel‚Äù.</p>
      </div>
    </div>
    <div class="actions">
      <button class="btnAccent" id="btnWeeklyPrint">Generar reporte semanal</button>
      <button class="btnAccent" id="btnPrint">Imprimir / Guardar PDF (todo)</button>
      <button id="btnExcel">Exportar a Excel (reporte)</button>
      <button id="btnExport">Exportar respaldo</button>
      <button id="btnImport">Importar respaldo</button>
      <button id="btnReset">Reset (solo si de verdad)</button>
      <input type="file" id="importFile" accept="application/json" style="display:none" />
    </div>
  </div>
</header>

<div class="wrap printOnly">
  <h2 style="margin:12px 0 0;">Reporte de Capacitaci√≥n ‚Äî Capacitaci√≥n ALPACEL</h2>
  <p style="margin:6px 0 0;color:#444;">(Versi√≥n impresa del registro)</p>
</div>

<main class="grid">

  <section class="card" style="grid-column: 1 / -1;">
    <div class="cardHeader">
      <div>
        <h2>Calendario semanal (aparte del reporte)</h2>
        <div class="sub">Un campo por d√≠a. Directo, sin vueltas.</div>
      </div>
      <div class="row noPrint" style="align-items:center;">
        <span class="pill">üóìÔ∏è Semana del: <input data-k="weekOf" type="text" placeholder="Ej. 29/Dic/2025" style="width:150px; padding:6px 8px;border-radius:12px"/></span>
      </div>
    </div>
    <div class="cardBody">
      <div class="mini">Escribe lo esencial por d√≠a: actividad principal, farmacia, enfoque y cierre.</div>

      <div class="split" style="margin-top:12px">
        <div class="field">
          <label>Lunes</label>
          <textarea data-k="cal_lun" placeholder="Actividad del lunes..."></textarea>
        </div>
        <div class="field">
          <label>Martes</label>
          <textarea data-k="cal_mar" placeholder="Actividad del martes..."></textarea>
        </div>
      </div>

      <div class="split" style="margin-top:12px">
        <div class="field">
          <label>Mi√©rcoles</label>
          <textarea data-k="cal_mie" placeholder="Actividad del mi√©rcoles..."></textarea>
        </div>
        <div class="field">
          <label>Jueves</label>
          <textarea data-k="cal_jue" placeholder="Actividad del jueves..."></textarea>
        </div>
      </div>

      <div class="split" style="margin-top:12px">
        <div class="field">
          <label>Viernes</label>
          <textarea data-k="cal_vie" placeholder="Actividad del viernes..."></textarea>
        </div>
        <div class="field">
          <label>S√°bado</label>
          <textarea data-k="cal_sab" placeholder="Actividad del s√°bado..."></textarea>
        </div>
      </div>

      <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
        <span class="pill">Auto-guardado ‚úÖ</span>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="cardHeader">
      <div>
        <h2>3) Checklist de lo realizado en farmacia</h2>
        <div class="sub">Hecho/no hecho. Lo dem√°s es cuento.</div>
      </div>
      <span class="pill">‚úÖ Evidencia: notas abajo</span>
    </div>
    <div class="cardBody">
      <div class="checklist" id="checklist"></div>
      <div style="margin-top:12px">
        <label>Notas / Evidencia r√°pida</label>
        <textarea data-k="checkNotes" placeholder="Ej. Se revis√≥ bolet√≠n, se reforz√≥ PCP con guion de cierre, se dej√≥ plan de trabajo semanal..."></textarea>
      </div>
    </div>
  </aside>

  <section class="card" style="grid-column: 1 / -1;">
    <div class="cardHeader">
      <div>
        <h2>2) Reporte editable de indicadores (para entregar)</h2>
        <div class="sub">Sem√°foro fijo: üü¢ 100%+ | üü° 90‚Äì99% | üî¥ &lt;90%.</div>
      </div>
      <div class="row noPrint" style="align-items:center;">
        <span class="pill">üü¢ ‚â•100%</span>
        <span class="pill">üü° 90‚Äì99%</span>
        <span class="pill">üî¥ &lt;90%</span>
        <span class="pill">Sem√°foro autom√°tico</span>
      </div>
    </div>

    <div class="cardBody">

      <div class="split">
        <div class="card" style="box-shadow:none;border-radius:16px;">
          <div class="cardBody">
            <div class="row">
              <div class="field"><label>Farmacia</label><input data-k="farmacia" type="text" placeholder="Ej. Saltillo ___" /></div>
              <div class="field"><label>Fecha</label><input data-k="fecha" type="text" placeholder="DD/MM/AAAA" /></div>
              <div class="field"><label>Encargado(a)</label><input data-k="encargado" type="text" placeholder="Nombre" /></div>
              <div class="field"><label>Hora de interacci√≥n</label><input data-k="hora" type="text" placeholder="Ej. 10:30" /></div>
            </div>
            <div class="mini" style="margin-top:8px">Encabezado del reporte.</div>
          </div>
        </div>

        <div class="card" style="box-shadow:none;border-radius:16px;">
          <div class="cardBody">
            <label>Objetivo / contexto breve</label>
            <textarea data-k="objetivo" placeholder="Ej. Reforzar pol√≠ticas operativas y empujar PCP; revisar bolet√≠n y ejecutar estrategia de venta del d√≠a."></textarea>
            <div class="footerSig">
              <div><b>Lic. Cecilia Avila</b><br/>Capacitaci√≥n ALPACEL</div>
              <div class="muted">El futuro se construye con h√°bitos. Y h√°bitos con seguimiento.</div>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:14px" class="card">
        <div class="cardHeader">
          <div>
            <h2 style="font-size:14px">Seguimiento de farmacia ‚Äî Indicadores (Meta / Proyecci√≥n / Alcance + Sem√°foro)</h2>
            <div class="sub">Venta total, Presupuesto, PCP, CEPIP, Impulso.</div>
          </div>
          <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <button id="recalcSema">Recalcular sem√°foro</button>
            <button id="resetKpis">Reiniciar indicadores</button>
          </div>
        </div>
        <div class="cardBody" style="overflow:auto;">
          <table id="kpiTable">
            <thead>
              <tr>
                <th style="min-width:200px">Indicador</th>
                <th style="min-width:130px">Meta</th>
                <th style="min-width:130px">Proyecci√≥n</th>
                <th style="min-width:130px">Alcance</th>
                <th style="min-width:170px">Sem√°foro</th>
                <th style="min-width:170px">Lectura</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="mini" style="margin-top:10px">Acepta: 81% o 0.81 o 81. T√∫ escribe; yo convierto.</div>
        </div>
      </div>

      <div style="margin-top:14px" class="card">
        <div class="cardHeader">
          <div>
            <h2 style="font-size:14px">Indicadores individuales por colaborador ‚Äî APP / PCP / PXN / %Bateo (Meta vs Alcance + Sem√°foro)</h2>
            <div class="sub">Aqu√≠ se ve qui√©n empuja y qui√©n nom√°s ‚Äúanda‚Äù. Con cari√±o‚Ä¶ y con datos.</div>
          </div>
          <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
            <button id="addIndRow">+ Agregar colaborador</button>
            <button id="resetInd">Limpiar tabla</button>
            <button id="recalcInd">Recalcular sem√°foros</button>
          </div>
        </div>
        <div class="cardBody" style="overflow:auto;">
          <table id="indTable">
            <thead>
              <tr>
                <th style="min-width:240px">Nombre</th>
                <th style="min-width:110px">APP Meta</th><th style="min-width:110px">APP Alc</th><th style="min-width:140px">APP Sem√°foro</th>
                <th style="min-width:110px">PCP Meta</th><th style="min-width:110px">PCP Alc</th><th style="min-width:140px">PCP Sem√°foro</th>
                <th style="min-width:110px">PXN Meta</th><th style="min-width:110px">PXN Alc</th><th style="min-width:140px">PXN Sem√°foro</th>
                <th style="min-width:110px">%Bateo Meta</th><th style="min-width:110px">%Bateo Alc</th><th style="min-width:140px">%Bateo Sem√°foro</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="mini" style="margin-top:10px">Sem√°foro por m√©trica: üü¢ (alc/meta ‚â• 1.00) | üü° (0.90‚Äì0.99) | üî¥ (&lt;0.90).</div>
        </div>
      </div>

      <div class="split" style="margin-top:14px">
        <div class="card">
          <div class="cardHeader">
            <div>
              <h2 style="font-size:14px">Compromisos del colaborador</h2>
              <div class="sub">Corto, medible y con fecha.</div>
            </div>
            <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap;">
              <button id="addCommit">+ Agregar compromiso</button>
              <button id="resetCommit">Limpiar</button>
            </div>
          </div>
          <div class="cardBody" style="overflow:auto;">
            <table id="commitTable">
              <thead><tr><th style="min-width:90px">N√∫mero</th><th>Compromiso</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="cardHeader">
            <div>
              <h2 style="font-size:14px">Observaciones del capacitador</h2>
              <div class="sub">Institucional, firme y accionable.</div>
            </div>
          </div>
          <div class="cardBody">
            <textarea data-k="observaciones" style="min-height:210px" placeholder="Ej. Se detecta fuga en cierre de PCP. Reforzar guion..."></textarea>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="cardHeader">
          <div><h2 style="font-size:14px">Firmas</h2><div class="sub">Forma tradicional. Cierre profesional.</div></div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="field"><label>Capacitador</label><input data-k="firmaCap" type="text" value="Lic. Cecilia Avila" /></div>
            <div class="field"><label>√Årea</label><input data-k="firmaArea" type="text" value="Capacitaci√≥n ALPACEL" /></div>
            <div class="field"><label>Encargado(a) de farmacia</label><input data-k="firmaEnc" type="text" placeholder="Nombre y firma" /></div>
          </div>
          <div class="mini" style="margin-top:10px">En PDF salen como texto. Si quieres firma manuscrita: imprimes y firmas.</div>
        </div>
      </div>

    </div>
  </section>

</main>

<script>
const STORE_KEY = "alpacel_capacitacion_agenda_reporte_v2_1";

/* Storage seguro: si el navegador bloquea localStorage (pasa en algunos modos/visores),
   el sistema sigue funcionando con memoria temporal. */
let __memStore = {};
function storageOK(){
  try{
    const k="__t"; localStorage.setItem(k,"1"); localStorage.removeItem(k);
    return true;
  }catch(e){ return false; }
}
const HAS_LS = storageOK();

function loadStore(){
  try{
    if(HAS_LS){
      return JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
    }
    return (__memStore || {});
  }catch(e){
    return (__memStore || {});
  }
}
function saveStore(obj){
  try{
    if(HAS_LS){
      localStorage.setItem(STORE_KEY, JSON.stringify(obj));
    }else{
      __memStore = obj;
    }
  }catch(e){
    __memStore = obj;
  }
}
let store = loadStore();

function setByPath(obj, path, val){
  const parts = path.split(".");
  let cur = obj;
  for(let i=0;i<parts.length-1;i++){
    cur[parts[i]] = cur[parts[i]] ?? {};
    cur = cur[parts[i]];
  }
  cur[parts[parts.length-1]] = val;
}
function getByPath(obj, path, fallback=""){
  const parts = path.split(".");
  let cur = obj;
  for(const p of parts){
    if(cur && Object.prototype.hasOwnProperty.call(cur,p)) cur = cur[p];
    else return fallback;
  }
  return (cur ?? fallback);
}
function bindFields(){
  document.querySelectorAll("[data-k]").forEach(el=>{
    const k = el.getAttribute("data-k");
    const val = getByPath(store, "fields."+k, "");
    el.value = val;
    el.addEventListener("input", ()=>{
      setByPath(store, "fields."+k, el.value);
      saveStore(store);
    });
  });
}
function makeCellInput(value, placeholder=""){
  const inp = document.createElement("input");
  inp.className = "cellInput";
  inp.value = value ?? "";
  inp.placeholder = placeholder;
  return inp;
}
function makeCellTA(value, placeholder=""){
  const ta = document.createElement("textarea");
  ta.className = "cellInput";
  ta.style.minHeight = "70px";
  ta.value = value ?? "";
  ta.placeholder = placeholder;
  return ta;
}
function parseNumRaw(x){
  if(x === null || x === undefined) return {num: NaN, isPct:false, raw:""};
  const raw = String(x).trim();
  if(!raw) return {num: NaN, isPct:false, raw:""};
  const isPct = /%$/.test(raw);
  // tolera separadores de miles y espacios
  const cleaned = raw.replace(/%$/,"").replace(/\s+/g,"").replace(/,/g,"");
  const num = Number(cleaned);
  return {num, isPct, raw};
}

/* ratioFrom: entiende cuando el usuario escribe el alcance como % (ej. 104%)
   aunque la meta est√© en n√∫mero absoluto. Tambi√©n entiende 81 como 81% si la meta es grande. */
function ratioFrom(metaRaw, alcRaw){
  const M = parseNumRaw(metaRaw);
  const A = parseNumRaw(alcRaw);
  if(Number.isNaN(M.num) || M.num === 0 || Number.isNaN(A.num)) return NaN;

  // Alcance en % expl√≠cito (104%)
  if(A.isPct && !M.isPct) return A.num / 100;
  if(A.isPct && M.isPct)  return A.num / M.num;

  // Meta en % (100 o 95%)
  if(M.isPct){
    const alcPct = A.isPct ? A.num : (A.num <= 2 ? A.num*100 : A.num);
    return alcPct / M.num;
  }

  // Ninguno trae %: heur√≠stica para metas grandes (ventas/presupuesto)
  const metaAbs = M.num;
  const alcVal  = A.num;

  if(metaAbs >= 1000){
    if(alcVal <= 1.5) return alcVal;        // 0.81 => 81%
    if(alcVal <= 200) return alcVal / 100;  // 81 => 81%
  }
  return alcVal / metaAbs; // comparaci√≥n absoluta
}

function semaFromRatio(r){
  if(Number.isNaN(r)) return {cls:"warn", label:"Sin dato", note:"Completa Meta y Alcance"};
  if(r >= 1.0) return {cls:"good", label:"Verde", note:"‚â•100%"};
  if(r >= 0.90) return {cls:"warn", label:"Amarillo", note:"90‚Äì99%"};
  return {cls:"bad", label:"Rojo", note:"<90%"};
}
function makeSemaBadge(r){
  const s = semaFromRatio(r);
  const badge = document.createElement("span");
  badge.className = "sema";
  const dot = document.createElement("span");
  dot.className = "dot " + s.cls;
  const label = document.createElement("span");
  label.textContent = s.label;
  badge.appendChild(dot); badge.appendChild(label);
  return badge;
}

/* Calendario semanal (1 campo por d√≠a): se guarda v√≠a [data-k] */

/* KPIs farmacia */
const kpiBody = document.querySelector("#kpiTable tbody");
function defaultKpis(){
  return [
    {indicador:"Venta total", meta:"", proy:"", alc:""},
    {indicador:"Presupuesto", meta:"", proy:"", alc:""},
    {indicador:"PCP", meta:"", proy:"", alc:""},
    {indicador:"CEPIP", meta:"", proy:"", alc:""},
    {indicador:"Impulso", meta:"", proy:"", alc:""},
  ];
}
function paintKpiRow(tr, row){
  const r = ratioFrom(row.meta, row.alc);
  const s = semaFromRatio(r);
  tr._sema.dot.className = "dot " + s.cls;
  tr._sema.label.textContent = s.label;
  tr._sema.note.textContent = Number.isNaN(r) ? "Completa Meta y Alcance" : `${s.note} ‚Äî ${(r*100).toFixed(1)}% del objetivo`;
}
function renderKpis(){
  const rows = getByPath(store, "tables.kpis", null) ?? defaultKpis();
  setByPath(store, "tables.kpis", rows);
  saveStore(store);

  kpiBody.innerHTML = "";
  rows.forEach((row, idx)=>{
    const tr = document.createElement("tr");

    const tdInd = document.createElement("td");
    const ind = makeCellInput(row.indicador, "Indicador");
    ind.addEventListener("input", ()=>{ store.tables.kpis[idx].indicador = ind.value; saveStore(store); });
    tdInd.appendChild(ind);
    tr.appendChild(tdInd);

    ["meta","proy","alc"].forEach((c,i)=>{
      const td = document.createElement("td");
      const inp = makeCellInput(row[c], i===0?"Meta":(i===1?"Proyecci√≥n":"Alcance"));
      inp.addEventListener("input", ()=>{
        store.tables.kpis[idx][c] = inp.value;
        saveStore(store);
        paintKpiRow(tr, store.tables.kpis[idx]);
      });
      td.appendChild(inp);
      tr.appendChild(td);
    });

    const tdS = document.createElement("td");
    const badge = document.createElement("span");
    badge.className = "sema";
    const dot = document.createElement("span"); dot.className="dot warn";
    const label = document.createElement("span"); label.textContent="Sin dato";
    badge.appendChild(dot); badge.appendChild(label);
    tdS.appendChild(badge);
    tr.appendChild(tdS);

    const tdN = document.createElement("td");
    tdN.className = "muted";
    tdN.textContent = "Completa Meta y Alcance";
    tr.appendChild(tdN);

    tr._sema = {dot, label, note: tdN};
    paintKpiRow(tr, row);
    kpiBody.appendChild(tr);
  });
}
document.getElementById("recalcSema").addEventListener("click", ()=>{
  [...kpiBody.querySelectorAll("tr")].forEach((tr, i)=> paintKpiRow(tr, store.tables.kpis[i]));
});
document.getElementById("resetKpis").addEventListener("click", ()=>{
  store.tables = store.tables || {};
  store.tables.kpis = defaultKpis();
  saveStore(store);
  renderKpis();
});

/* Indicadores individuales */
const indBody = document.querySelector("#indTable tbody");
function defaultIndRows(){
  return [
    {nombre:"", appM:"", appA:"", pcpM:"", pcpA:"", pxnM:"", pxnA:"", batM:"", batA:""},
    {nombre:"", appM:"", appA:"", pcpM:"", pcpA:"", pxnM:"", pxnA:"", batM:"", batA:""},
  ];
}
function renderInd(){
  const rows = getByPath(store, "tables.ind", null) ?? defaultIndRows();
  setByPath(store, "tables.ind", rows);
  saveStore(store);

  indBody.innerHTML = "";
  rows.forEach((row, idx)=>{
    const tr = document.createElement("tr");

    let td = document.createElement("td");
    const name = makeCellInput(row.nombre, "Nombre");
    name.addEventListener("input", ()=>{ store.tables.ind[idx].nombre = name.value; saveStore(store); });
    td.appendChild(name);
    tr.appendChild(td);

    function addMetric(keyM, keyA){
      let tdM = document.createElement("td");
      const m = makeCellInput(row[keyM], "Meta");
      m.addEventListener("input", ()=>{ store.tables.ind[idx][keyM] = m.value; saveStore(store); recalcRow(); });
      tdM.appendChild(m); tr.appendChild(tdM);

      let tdA = document.createElement("td");
      const a = makeCellInput(row[keyA], "Alc");
      a.addEventListener("input", ()=>{ store.tables.ind[idx][keyA] = a.value; saveStore(store); recalcRow(); });
      tdA.appendChild(a); tr.appendChild(tdA);

      let tdS = document.createElement("td");
      tdS.appendChild(makeSemaBadge(ratioFrom(row[keyM], row[keyA])));
      tr.appendChild(tdS);
      return {tdS, keyM, keyA};
    }

    const mAPP = addMetric("appM","appA");
    const mPCP = addMetric("pcpM","pcpA");
    const mPXN = addMetric("pxnM","pxnA");
    const mBAT = addMetric("batM","batA");

    function recalcRow(){
      const r1 = ratioFrom(store.tables.ind[idx][mAPP.keyM], store.tables.ind[idx][mAPP.keyA]);
      const r2 = ratioFrom(store.tables.ind[idx][mPCP.keyM], store.tables.ind[idx][mPCP.keyA]);
      const r3 = ratioFrom(store.tables.ind[idx][mPXN.keyM], store.tables.ind[idx][mPXN.keyA]);
      const r4 = ratioFrom(store.tables.ind[idx][mBAT.keyM], store.tables.ind[idx][mBAT.keyA]);

      mAPP.tdS.innerHTML=""; mAPP.tdS.appendChild(makeSemaBadge(r1));
      mPCP.tdS.innerHTML=""; mPCP.tdS.appendChild(makeSemaBadge(r2));
      mPXN.tdS.innerHTML=""; mPXN.tdS.appendChild(makeSemaBadge(r3));
      mBAT.tdS.innerHTML=""; mBAT.tdS.appendChild(makeSemaBadge(r4));
    }
    recalcRow();
    indBody.appendChild(tr);
  });
}
document.getElementById("addIndRow").addEventListener("click", ()=>{
  store.tables = store.tables || {};
  store.tables.ind = store.tables.ind || defaultIndRows();
  store.tables.ind.push({nombre:"", appM:"", appA:"", pcpM:"", pcpA:"", pxnM:"", pxnA:"", batM:"", batA:""});
  saveStore(store); renderInd();
});
document.getElementById("resetInd").addEventListener("click", ()=>{
  store.tables = store.tables || {};
  store.tables.ind = defaultIndRows();
  saveStore(store); renderInd();
});
document.getElementById("recalcInd").addEventListener("click", ()=>renderInd());

/* Compromisos */
const commitBody = document.querySelector("#commitTable tbody");
function defaultCommits(){ return [{n:"1", txt:""},{n:"2", txt:""},{n:"3", txt:""}]; }
function renderCommits(){
  const rows = getByPath(store, "tables.commits", null) ?? defaultCommits();
  setByPath(store, "tables.commits", rows);
  saveStore(store);

  commitBody.innerHTML = "";
  rows.forEach((r, idx)=>{
    const tr = document.createElement("tr");
    const tdN = document.createElement("td");
    const n = makeCellInput(r.n, "N¬∞");
    n.addEventListener("input", ()=>{ store.tables.commits[idx].n = n.value; saveStore(store); });
    tdN.appendChild(n); tr.appendChild(tdN);

    const tdT = document.createElement("td");
    const t = makeCellInput(r.txt, "Compromiso");
    t.addEventListener("input", ()=>{ store.tables.commits[idx].txt = t.value; saveStore(store); });
    tdT.appendChild(t); tr.appendChild(tdT);

    commitBody.appendChild(tr);
  });
}
document.getElementById("addCommit").addEventListener("click", ()=>{
  store.tables = store.tables || {};
  store.tables.commits = store.tables.commits || defaultCommits();
  store.tables.commits.push({n:String(store.tables.commits.length+1), txt:""});
  saveStore(store); renderCommits();
});
document.getElementById("resetCommit").addEventListener("click", ()=>{
  store.tables = store.tables || {};
  store.tables.commits = defaultCommits();
  saveStore(store); renderCommits();
});

/* Checklist */
const CHECK_ITEMS = [
  {k:"a", title:"Retroalimentaci√≥n de pol√≠ticas operativas", sub:"Alinear forma y fondo."},
  {k:"b", title:"Retroalimentaci√≥n de indicadores", sub:"APP, PCP, PXN, %BATEO, lectura y acciones."},
  {k:"c", title:"Capacitaci√≥n de productos", sub:"Producto correcto, discurso correcto."},
  {k:"d", title:"Revisi√≥n de bolet√≠n", sub:"Lo vigente manda."},
  {k:"e", title:"Estrategias de venta", sub:"Guion, objeciones, cierres."},
  {k:"f", title:"Plan de trabajo", sub:"Qu√©, qui√©n, cu√°ndo."},
  {k:"g", title:"Realizaci√≥n de pizarr√≥n", sub:"Visible y actualizado."},
  {k:"h", title:"Capacitaci√≥n de pr√≥ximos, inventario y pedido", sub:"Orden hoy para no llorar ma√±ana."},
  {k:"i", title:"Exhibiciones correctas", sub:"Se vende con ojos antes que con palabras."},
];
function renderChecklist(){
  const wrap = document.getElementById("checklist");
  wrap.innerHTML = "";
  store.check = store.check || {};
  CHECK_ITEMS.forEach(it=>{
    const div = document.createElement("div");
    div.className = "checkItem";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!store.check[it.k];
    cb.addEventListener("change", ()=>{ store.check[it.k] = cb.checked; saveStore(store); });

    const txt = document.createElement("div");
    txt.className = "txt";
    txt.innerHTML = `<b>(${it.k}) ${it.title}</b><span class="muted">${it.sub}</span>`;
    div.appendChild(cb); div.appendChild(txt);
    wrap.appendChild(div);
  });
}

/* Excel export (.xls compatible) */
function esc(s){
  return String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function buildReportTableHTML(){
  const f = store.fields || {};
  const kpis = (store.tables?.kpis || defaultKpis());
  const ind  = (store.tables?.ind  || defaultIndRows());
  const com  = (store.tables?.commits || defaultCommits());

  let h = `<table border="1"><tbody>`;
  h += `<tr><td colspan="6"><b>Capacitaci√≥n ALPACEL ‚Äî Reporte</b></td></tr>`;
  h += `<tr><td><b>Farmacia</b></td><td>${esc(f.farmacia)}</td><td><b>Fecha</b></td><td>${esc(f.fecha)}</td><td><b>Hora</b></td><td>${esc(f.hora)}</td></tr>`;
  h += `<tr><td><b>Encargado(a)</b></td><td colspan="5">${esc(f.encargado)}</td></tr>`;
  h += `<tr><td><b>Objetivo</b></td><td colspan="5">${esc(f.objetivo)}</td></tr>`;
  h += `<tr><td colspan="6"></td></tr>`;

  h += `<tr><td colspan="6"><b>Seguimiento de farmacia (Meta / Proyecci√≥n / Alcance / Sem√°foro)</b></td></tr>`;
  h += `<tr><td><b>Indicador</b></td><td><b>Meta</b></td><td><b>Proyecci√≥n</b></td><td><b>Alcance</b></td><td><b>Sem√°foro</b></td><td><b>Lectura</b></td></tr>`;
  kpis.forEach(r=>{
    const ratio = ratioFrom(r.meta, r.alc);
    const s = semaFromRatio(ratio);
    const lectura = Number.isNaN(ratio) ? "Completa Meta y Alcance" : `${s.note} ‚Äî ${(ratio*100).toFixed(1)}% del objetivo`;
    h += `<tr><td>${esc(r.indicador)}</td><td>${esc(r.meta)}</td><td>${esc(r.proy)}</td><td>${esc(r.alc)}</td><td>${esc(s.label)}</td><td>${esc(lectura)}</td></tr>`;
  });
  h += `<tr><td colspan="6"></td></tr>`;

  h += `<tr><td colspan="13"><b>Indicadores individuales (Meta / Alcance / Sem√°foro)</b></td></tr>`;
  h += `<tr>
    <td><b>Nombre</b></td>
    <td><b>APP Meta</b></td><td><b>APP Alc</b></td><td><b>APP Sem</b></td>
    <td><b>PCP Meta</b></td><td><b>PCP Alc</b></td><td><b>PCP Sem</b></td>
    <td><b>PXN Meta</b></td><td><b>PXN Alc</b></td><td><b>PXN Sem</b></td>
    <td><b>%Bateo Meta</b></td><td><b>%Bateo Alc</b></td><td><b>%Bateo Sem</b></td>
  </tr>`;
  ind.forEach(r=>{
    const s1 = semaFromRatio(ratioFrom(r.appM, r.appA)).label;
    const s2 = semaFromRatio(ratioFrom(r.pcpM, r.pcpA)).label;
    const s3 = semaFromRatio(ratioFrom(r.pxnM, r.pxnA)).label;
    const s4 = semaFromRatio(ratioFrom(r.batM, r.batA)).label;
    h += `<tr>
      <td>${esc(r.nombre)}</td>
      <td>${esc(r.appM)}</td><td>${esc(r.appA)}</td><td>${esc(s1)}</td>
      <td>${esc(r.pcpM)}</td><td>${esc(r.pcpA)}</td><td>${esc(s2)}</td>
      <td>${esc(r.pxnM)}</td><td>${esc(r.pxnA)}</td><td>${esc(s3)}</td>
      <td>${esc(r.batM)}</td><td>${esc(r.batA)}</td><td>${esc(s4)}</td>
    </tr>`;
  });
  h += `<tr><td colspan="13"></td></tr>`;

  h += `<tr><td colspan="6"><b>Compromisos</b></td></tr>`;
  h += `<tr><td><b>No.</b></td><td colspan="5"><b>Compromiso</b></td></tr>`;
  com.forEach(r=>{ h += `<tr><td>${esc(r.n)}</td><td colspan="5">${esc(r.txt)}</td></tr>`; });
  h += `<tr><td colspan="6"></td></tr>`;

  h += `<tr><td><b>Observaciones</b></td><td colspan="5">${esc(f.observaciones)}</td></tr>`;
  h += `<tr><td><b>Capacitador</b></td><td>${esc(f.firmaCap)}</td><td><b>√Årea</b></td><td>${esc(f.firmaArea)}</td><td><b>Encargado</b></td><td>${esc(f.firmaEnc)}</td></tr>`;
  h += `</tbody></table>`;
  return h;
}
function exportExcel(){
  const table = buildReportTableHTML();
  const content =
`<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="utf-8" /></head><body>${table}</body></html>`;
  const blob = new Blob([content], {type:"application/vnd.ms-excel;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `Reporte_Capacitacion_ALPACEL_${(store.fields?.farmacia||"Farmacia").toString().replace(/\s+/g,"_")}.xls`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
}
document.getElementById("btnExcel").addEventListener("click", exportExcel);

/* Reporte semanal imprimible (agenda + checklist + notas) */
function openWeeklyReportAndPrint(){
  const weekOf = store.fields?.weekOf || "";
  const farmacia = store.fields?.farmacia || "";
  const fecha = store.fields?.fecha || "";
  const encargado = store.fields?.encargado || "";
  const notes = store.fields?.checkNotes || "";

  const dias = [
    {d:"Lunes", k:"cal_lun"},
    {d:"Martes", k:"cal_mar"},
    {d:"Mi√©rcoles", k:"cal_mie"},
    {d:"Jueves", k:"cal_jue"},
    {d:"Viernes", k:"cal_vie"},
    {d:"S√°bado", k:"cal_sab"},
  ];

  const agenda = dias.map(x => {
    const val = (store.fields?.[x.k] || "").toString();
    return `<div style="margin:8px 0;padding:8px 10px;border:1px solid #ddd;border-radius:10px">
      <b>${esc(x.d)}:</b><div style="margin-top:6px">${esc(val).replace(/\n/g,"<br/>") || "<span style='color:#777'>(sin actividad)</span>"}</div>
    </div>`;
  }).join("");

  const checks = CHECK_ITEMS.map(it=>{
    const ok = !!store.check?.[it.k];
    return `<li style="margin:4px 0">${ok ? "‚òë" : "‚òê"} (${it.k}) ${esc(it.title)}</li>`;
  }).join("");

  const html =
`<!doctype html><html><head><meta charset="utf-8"/><title>Reporte semanal</title>
<style>
  @page{margin:14mm;}
  body{font-family:Arial,sans-serif;color:#111}
  h1{font-size:16px;margin:0}
  .sub{color:#444;margin:6px 0 12px;font-size:12px}
  .box{border:1px solid #ddd;border-radius:10px;padding:10px;margin:10px 0}
</style>
</head><body>
  <h1>Reporte semanal ‚Äî Capacitaci√≥n ALPACEL</h1>
  <div class="sub"><b>Semana del:</b> ${esc(weekOf)} &nbsp; | &nbsp; <b>Farmacia:</b> ${esc(farmacia)} &nbsp; | &nbsp; <b>Fecha:</b> ${esc(fecha)} &nbsp; | &nbsp; <b>Encargado(a):</b> ${esc(encargado)}</div>

  <div class="box"><b>Agenda semanal</b><div style="height:6px"></div>${agenda}</div>

  <div class="box"><b>Checklist</b><ul style="padding-left:18px;margin:8px 0">${checks}</ul></div>
  <div class="box"><b>Notas / evidencia</b><div style="margin-top:8px">${esc(notes).replace(/\n/g,"<br/>")}</div></div>

  <div style="margin-top:18px;font-size:12px;color:#444">
    <b>Lic. Cecilia Avila</b> ‚Äî Capacitaci√≥n ALPACEL
  </div>

<script>window.onload=()=>{ window.print(); };<\/script>
</body></html>`;

  const w = window.open("", "_blank");
  if(!w){ alert("Tu navegador bloque√≥ la ventana emergente. Permite pop-ups para imprimir."); return; }
  w.document.open();
  w.document.write(html);
  w.document.close();
}
document.getElementById("btnWeeklyPrint").addEventListener("click", openWeeklyReportAndPrint);


/* Respaldo / Print / Reset */
document.getElementById("btnPrint").addEventListener("click", ()=>window.print());
document.getElementById("btnExport").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(store, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "respaldo_capacitacion_alpacel_v2.json";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
});
document.getElementById("btnImport").addEventListener("click", ()=>document.getElementById("importFile").click());
document.getElementById("importFile").addEventListener("change", async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  const txt = await f.text();
  try{
    store = JSON.parse(txt);
    saveStore(store);
    init();
    alert("Listo: respaldo importado ‚úÖ");
  }catch(err){
    alert("Ese archivo no parece un respaldo v√°lido üòÖ");
  }finally{ e.target.value = ""; }
});
document.getElementById("btnReset").addEventListener("click", ()=>{
  const ok = confirm("¬øReset total? Se borra TODO lo guardado en este navegador.");
  if(!ok) return;
  localStorage.removeItem(STORE_KEY);
  store = {};
  init();
});

function init(){
  store.fields = store.fields || {};
  if(!store.fields.firmaCap) store.fields.firmaCap = "Lic. Cecilia Avila";
  if(!store.fields.firmaArea) store.fields.firmaArea = "Capacitaci√≥n ALPACEL";
  saveStore(store);

  bindFields();
  renderKpis();
  renderInd();
  renderCommits();
  renderChecklist();
}

// Arranque seguro
if(document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", init);
}else{
  init();
}
</script>
</body>
</html>
