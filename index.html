<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ALPACEL | Agenda de Capacitaci√≥n (Registro & Seguimiento)</title>
  <meta name="description" content="Agenda de capacitaci√≥n ALPACEL: sesiones, evaluaci√≥n 0‚Äì100, compromisos, sem√°foro por farmacia, exportar/importar y acta imprimible."/>
  <style>
    :root{
      --bg0:#070018;
      --bg1:#0b0a2a;
      --line: rgba(255,255,255,.12);
      --text:#f5f7ff;
      --muted: rgba(245,247,255,.75);

      --pink:#ff2bd6;
      --cyan:#00e5ff;
      --lime:#b7ff00;
      --orange:#ff8a00;
      --red:#ff3b3b;
      --green:#22ff88;

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background:
        radial-gradient(1000px 700px at 15% 10%, rgba(255,43,214,.26), transparent 60%),
        radial-gradient(900px 650px at 85% 15%, rgba(0,229,255,.22), transparent 60%),
        radial-gradient(1000px 700px at 55% 90%, rgba(183,255,0,.16), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, #050014);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(12px);
      background: rgba(8,4,30,.55);
      border-bottom: 1px solid var(--line);
    }
    .wrap{max-width:1280px; margin:0 auto; padding:18px 16px;}
    .top{
      display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; align-items:flex-start;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:46px; height:46px; border-radius: 16px;
      background: conic-gradient(from 210deg, var(--pink), var(--cyan), var(--lime), var(--orange), var(--pink));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight: 900;
      color:#0b0030;
      user-select:none;
      letter-spacing:.5px;
    }
    h1{margin:0; font-size:18px; letter-spacing:.2px}
    .sub{margin-top:2px; color:var(--muted); font-size:13px; line-height:1.35}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 16px;
      cursor:pointer;
      transition:.18s ease;
      display:inline-flex; gap:8px; align-items:center;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.09)}
    .btn.primary{border-color: rgba(0,229,255,.45); background: rgba(0,229,255,.14)}
    .btn.ok{border-color: rgba(34,255,136,.45); background: rgba(34,255,136,.12)}
    .btn.warn{border-color: rgba(255,138,0,.45); background: rgba(255,138,0,.12)}
    .btn.danger{border-color: rgba(255,59,59,.45); background: rgba(255,59,59,.12)}
    .btn.pink{border-color: rgba(255,43,214,.45); background: rgba(255,43,214,.12)}

    .grid{
      display:grid;
      grid-template-columns: 460px 1fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 1040px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .bd{padding:14px}
    .muted{color:var(--muted)}
    label{display:block; font-size:12px; color:var(--muted); margin:6px 0 6px}
    input, select, textarea{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical}
    input::placeholder, textarea::placeholder{color: rgba(245,247,255,.55)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    @media (max-width: 700px){ .row, .row3{grid-template-columns:1fr} }
    .hr{height:1px; background: var(--line); margin:12px 0}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: 999px;
      padding:6px 10px;
      font-size:12px;
      display:inline-flex; gap:8px; align-items:center;
    }
    .dot{width:10px; height:10px; border-radius: 999px; display:inline-block}
    .dot.g{background:var(--green)}
    .dot.y{background:var(--orange)}
    .dot.r{background:var(--red)}
    .dot.c{background:var(--cyan)}

    .kpis{display:grid; grid-template-columns: repeat(4, 1fr); gap:10px}
    @media (max-width: 1000px){ .kpis{grid-template-columns: repeat(2, 1fr)} }
    .kpi{
      padding:12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
    }
    .kpi .t{font-size:12px; color:var(--muted)}
    .kpi .n{font-size:20px; font-weight:900; margin-top:6px}

    .list{display:flex; flex-direction:column; gap:10px; padding:12px}
    .item{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 20px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      transition:.18s ease;
      cursor:pointer;
    }
    .item:hover{transform: translateY(-1px); background: rgba(0,0,0,.22)}
    .item h3{margin:0; font-size:14px}
    .meta{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .b-ok{border-color: rgba(34,255,136,.45); background: rgba(34,255,136,.10)}
    .b-warn{border-color: rgba(255,138,0,.50); background: rgba(255,138,0,.10)}
    .b-bad{border-color: rgba(255,59,59,.50); background: rgba(255,59,59,.10)}
    .b-info{border-color: rgba(0,229,255,.55); background: rgba(0,229,255,.10)}
    .b-pink{border-color: rgba(255,43,214,.55); background: rgba(255,43,214,.10)}
    .actions{display:flex; flex-direction:column; align-items:flex-end; gap:8px}
    .hint{font-size:12px; color:var(--muted); line-height:1.45}

    .table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    .table th,.table td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-align:left;
      vertical-align:top;
    }
    .table th{color:var(--muted); font-weight:800; background: rgba(255,255,255,.04)}
    .table tr:last-child td{border-bottom:none}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      font-size:12px;
    }
    .pill .bar{width:10px; height:10px; border-radius:999px; background: var(--cyan)}
    .pill.ok .bar{background: var(--green)}
    .pill.warn .bar{background: var(--orange)}
    .pill.bad .bar{background: var(--red)}

    dialog{
      border:none; border-radius: 22px;
      width:min(920px, 94vw);
      background: linear-gradient(180deg, rgba(16,10,50,.96), rgba(6,0,28,.96));
      color:var(--text);
      box-shadow: var(--shadow);
    }
    dialog::backdrop{background: rgba(0,0,0,.62)}
    .dlg-hd{padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center}
    .dlg-bd{padding:14px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .follow{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 18px;
      padding:10px;
      display:flex; flex-direction:column; gap:8px;
    }
    .follow-entry{
      border:1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      padding:10px;
    }
    .footer{padding:16px; text-align:center; color:var(--muted); font-size:12px; opacity:.95}
    @media print{
      body{background:#fff; color:#111}
      header, .no-print{display:none !important}
      .print-card{
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
      }
      .table{border-color:#ddd; background:#fff}
      .table th,.table td{border-color:#ddd; color:#111}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="logo">C</div>
      <div>
        <h1>ALPACEL ‚Äî Agenda de Capacitaci√≥n</h1>
        <div class="sub">
          Registro & seguimiento de sesiones. Evaluaci√≥n 0‚Äì100, compromisos, evidencia y cierre.<br/>
          <span class="muted">Hecho por: <b>Lic. Cecilia √Åvila</b> ‚Ä¢ Coordinaci√≥n de Capacitaci√≥n</span>
        </div>
      </div>
    </div>
    <div class="toolbar no-print">
      <button class="btn primary" id="btnNew">‚ûï Nueva sesi√≥n</button>
      <button class="btn" id="btnExport">‚¨áÔ∏è Exportar JSON</button>
      <label class="btn" for="importFile" style="margin:0; cursor:pointer;">‚¨ÜÔ∏è Importar JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none;">
      <button class="btn" id="btnExportCSV">üìÑ Exportar CSV</button>
      <button class="btn danger" id="btnWipe">üßπ Borrar todo</button>
      <button class="btn pink" id="btnHelp">‚ùì Ayuda</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- FORM -->
    <section class="card">
      <div class="hd">
        <div>
          <div style="font-weight:900">Registro de sesi√≥n</div>
          <div class="hint">Lo que se ense√±a se mide. Lo que se mide se mejora. Y s√≠: la evidencia manda.</div>
        </div>
        <div class="chips">
          <span class="chip"><span class="dot c"></span>Guarda offline</span>
          <span class="chip"><span class="dot y"></span>Seguimiento</span>
          <span class="chip"><span class="dot g"></span>Cierre</span>
        </div>
      </div>
      <div class="bd">
        <form id="form" class="no-print">
          <div class="row">
            <div>
              <label>Farmacia / Sucursal</label>
              <select id="farmacia" required></select>
            </div>
            <div>
              <label>Fecha</label>
              <input id="fecha" type="date" required />
            </div>
          </div>

          <div class="row3">
            <div>
              <label>Horario inicio</label>
              <input id="hini" type="time" required />
            </div>
            <div>
              <label>Horario fin</label>
              <input id="hfin" type="time" required />
            </div>
            <div>
              <label>Modalidad</label>
              <select id="modalidad" required>
                <option>Presencial</option>
                <option>Mixta</option>
                <option>Remota</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Capacitador(a)</label>
              <input id="capacitador" value="Lic. Cecilia √Åvila" />
            </div>
            <div>
              <label>Tipo de capacitaci√≥n</label>
              <select id="tipo" required>
                <option>Inducci√≥n</option>
                <option selected>Refuerzo</option>
                <option>Correctiva</option>
                <option>Indicadores</option>
                <option>Sanitaria</option>
                <option>Operativa</option>
              </select>
            </div>
          </div>

          <label>Tema(s) tratados</label>
          <textarea id="temas" placeholder="Ej: Protocolo de atenci√≥n, CEPIP, impulso, app comercial, PNO..." required></textarea>

          <div class="row">
            <div>
              <label>Personal capacitado (nombres)</label>
              <textarea id="personal" placeholder="Ej: Carolina Garc√≠a, Julio Adri√°n Lechuga, ..."></textarea>
            </div>
            <div>
              <label>Evidencia (link / nota)</label>
              <textarea id="evidencia" placeholder="Ej: Fotos en Drive, captura Simiescuela, formato firmado, etc."></textarea>
            </div>
          </div>

          <div class="row3">
            <div>
              <label>Estatus</label>
              <select id="estatus" required>
                <option selected>Programada</option>
                <option>Impartida</option>
                <option>En seguimiento</option>
                <option>Cerrada</option>
              </select>
            </div>
            <div>
              <label>Fecha compromiso</label>
              <input id="fechaComp" type="date" />
            </div>
            <div>
              <label>Impacto esperado</label>
              <input id="impacto" placeholder="Ej: Mejorar PCP, reforzar facturaci√≥n, subir CEPIP..." />
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
            <div>
              <div style="font-weight:900">Evaluaci√≥n de la sesi√≥n (0‚Äì100)</div>
              <div class="hint">Marca ‚ÄúS√≠‚Äù o ‚ÄúNo‚Äù. El puntaje se calcula solo.</div>
            </div>
            <div class="chip"><span class="dot c"></span><b>Puntaje:</b> <span id="scoreNow">0</span>/100</div>
          </div>

          <div class="hr"></div>

          <div id="evalGrid"></div>

          <div class="hr"></div>

          <label>Observaciones del capacitador</label>
          <textarea id="obs" placeholder="Hechos, evidencia y acci√≥n. Corto y contundente."></textarea>

          <label>Compromisos (uno por l√≠nea)</label>
          <textarea id="compromisos" placeholder="Ej:
1) Reforzar menci√≥n de facturaci√≥n en cierre.
2) Checklist diario de CEPIP.
3) Seguimiento en 7 d√≠as."></textarea>

          <div class="hr"></div>

          <div class="row">
            <button class="btn ok" type="submit">‚úÖ Guardar sesi√≥n</button>
            <button class="btn warn" type="button" id="btnClear">üßº Limpiar</button>
          </div>

          <p class="hint">Si no qued√≥ escrito, fue un ‚Äúme acord√© tantito‚Äù y eso no cuenta. üòå</p>
        </form>

        <div class="hr"></div>

        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div style="font-weight:900">Sem√°foro por farmacia</div>
            <div class="hint">Rojo: pendientes/vencidas ‚Ä¢ Amarillo: seguimiento ‚Ä¢ Verde: cerrado.</div>
          </div>
          <div class="hr"></div>
          <div id="farmTable"></div>
        </div>
      </div>
    </section>

    <!-- LIST -->
    <section class="card">
      <div class="hd">
        <div>
          <div style="font-weight:900">Agenda & seguimiento</div>
          <div class="hint">Filtra, busca, abre una sesi√≥n y dale continuidad. Con m√©todo.</div>
        </div>
        <div class="chips">
          <span class="chip"><span class="dot g"></span>Cerrada</span>
          <span class="chip"><span class="dot y"></span>Seguimiento</span>
          <span class="chip"><span class="dot r"></span>Pendiente</span>
        </div>
      </div>
      <div class="bd">
        <div class="kpis" id="kpis"></div>

        <div class="hr"></div>

        <div class="row3 no-print">
          <div>
            <label>Buscar</label>
            <input id="q" placeholder="Farmacia, temas, capacitador, personal..." />
          </div>
          <div>
            <label>Estatus</label>
            <select id="fEstatus">
              <option value="">Todos</option>
              <option>Programada</option>
              <option>Impartida</option>
              <option>En seguimiento</option>
              <option>Cerrada</option>
            </select>
          </div>
          <div>
            <label>Ordenar</label>
            <select id="sortBy">
              <option value="updated_desc" selected>√öltima actualizaci√≥n</option>
              <option value="date_desc">Fecha (desc)</option>
              <option value="date_asc">Fecha (asc)</option>
              <option value="score_desc">Puntaje (alto‚Üíbajo)</option>
              <option value="farmacia">Farmacia (A‚ÜíZ)</option>
            </select>
          </div>
        </div>

        <div class="row3 no-print">
          <div>
            <label>Desde</label>
            <input id="fromDate" type="date" />
          </div>
          <div>
            <label>Hasta</label>
            <input id="toDate" type="date" />
          </div>
          <div>
            <label>Vista</label>
            <select id="viewMode">
              <option value="cards" selected>Tarjetas</option>
              <option value="table">Tabla</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="list" id="list"></div>
      </div>
    </section>
  </div>

  <div class="footer">ALPACEL ‚Ä¢ Capacitaci√≥n con evidencia ‚Ä¢ Tradici√≥n: disciplina ‚Ä¢ Futuro: datos ‚ú®</div>
</main>

<!-- DETAIL DIALOG -->
<dialog id="dlg">
  <div class="dlg-hd">
    <div>
      <div class="mono" style="font-weight:900" id="dlgTitle">Detalle</div>
      <div class="hint" id="dlgSub"></div>
    </div>
    <div class="no-print" style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn primary" id="btnPrint">üñ®Ô∏è Acta</button>
      <button class="btn" id="dlgClose">‚úñÔ∏è Cerrar</button>
    </div>
  </div>
  <div class="dlg-bd">
    <div class="row3 no-print">
      <div>
        <label>Estatus</label>
        <select id="dEstatus">
          <option>Programada</option>
          <option>Impartida</option>
          <option>En seguimiento</option>
          <option>Cerrada</option>
        </select>
      </div>
      <div>
        <label>Fecha compromiso</label>
        <input id="dFechaComp" type="date" />
      </div>
      <div>
        <label>Capacitador(a)</label>
        <input id="dCapacitador" />
      </div>
    </div>

    <div class="row no-print">
      <div>
        <label>Farmacia</label>
        <select id="dFarmacia"></select>
      </div>
      <div>
        <label>Tipo</label>
        <select id="dTipo">
          <option>Inducci√≥n</option>
          <option>Refuerzo</option>
          <option>Correctiva</option>
          <option>Indicadores</option>
          <option>Sanitaria</option>
          <option>Operativa</option>
        </select>
      </div>
    </div>

    <div class="row3 no-print">
      <div>
        <label>Fecha</label>
        <input id="dFecha" type="date" />
      </div>
      <div>
        <label>Inicio</label>
        <input id="dHini" type="time" />
      </div>
      <div>
        <label>Fin</label>
        <input id="dHfin" type="time" />
      </div>
    </div>

    <div class="row no-print">
      <div>
        <label>Temas</label>
        <textarea id="dTemas"></textarea>
      </div>
      <div>
        <label>Personal</label>
        <textarea id="dPersonal"></textarea>
      </div>
    </div>

    <div class="row no-print">
      <div>
        <label>Evidencia</label>
        <textarea id="dEvidencia"></textarea>
      </div>
      <div>
        <label>Observaciones</label>
        <textarea id="dObs"></textarea>
      </div>
    </div>

    <div class="row no-print">
      <div>
        <label>Impacto esperado</label>
        <input id="dImpacto" />
      </div>
      <div>
        <label>Puntaje</label>
        <input id="dScore" readonly />
      </div>
    </div>

    <label class="no-print">Compromisos</label>
    <textarea class="no-print" id="dCompromisos"></textarea>

    <div class="hr"></div>

    <div class="follow no-print">
      <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
        <div>
          <div style="font-weight:900">Seguimiento</div>
          <div class="hint">Notas con fecha: avance, evidencia, visita, cierre.</div>
        </div>
        <button class="btn primary" id="btnAddFollow">üìù Agregar</button>
      </div>
      <div id="followList"></div>
    </div>

    <div class="hr no-print"></div>

    <div class="no-print" style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <button class="btn ok" id="btnSave">üíæ Guardar cambios</button>
      <button class="btn danger" id="btnDelete">üóëÔ∏è Eliminar</button>
    </div>

    <!-- PRINT ACTA -->
    <div id="acta" class="print-card" style="display:none;">
      <div style="display:flex; justify-content:space-between; gap:14px; align-items:flex-start;">
        <div>
          <div style="font-weight:900; font-size:16px;">ALPACEL ‚Äî Acta de Capacitaci√≥n</div>
          <div style="font-size:12px; margin-top:6px;">Coordinaci√≥n de Capacitaci√≥n ‚Ä¢ Evidencia ‚Ä¢ Compromisos ‚Ä¢ Seguimiento</div>
          <div style="font-size:12px; margin-top:6px;"><b>Capacitador(a):</b> Lic. Cecilia √Åvila</div>
        </div>
        <div style="text-align:right; font-size:12px;">
          <div><b>Impresi√≥n:</b> <span id="aToday"></span></div>
          <div><b>Folio:</b> <span class="mono" id="aFolio"></span></div>
        </div>
      </div>

      <div style="height:10px"></div>

      <table class="table">
        <tr><th>Farmacia</th><td id="aFarm"></td><th>Fecha</th><td id="aFecha"></td></tr>
        <tr><th>Horario</th><td id="aHora"></td><th>Modalidad</th><td id="aMod"></td></tr>
        <tr><th>Tipo</th><td id="aTipo"></td><th>Estatus</th><td id="aStatus"></td></tr>
        <tr><th>Temas</th><td colspan="3" id="aTemas"></td></tr>
        <tr><th>Personal</th><td colspan="3" id="aPersonal"></td></tr>
        <tr><th>Evidencia</th><td colspan="3" id="aEvi"></td></tr>
        <tr><th>Observaciones</th><td colspan="3" id="aObs"></td></tr>
        <tr><th>Compromisos</th><td colspan="3" id="aComp"></td></tr>
        <tr><th>Puntaje</th><td id="aScore"></td><th>Impacto</th><td id="aImpacto"></td></tr>
        <tr><th>Fecha compromiso</th><td id="aFcomp"></td><th>Seguimientos</th><td id="aFcount"></td></tr>
      </table>

      <div style="height:12px"></div>
      <div style="font-weight:900; margin-bottom:6px;">Seguimiento</div>
      <table class="table" id="aFollowTbl">
        <tr><th>#</th><th>Fecha</th><th>Tipo</th><th>Nota</th></tr>
      </table>

      <div style="height:14px"></div>
      <div class="row" style="gap:18px;">
        <div>
          <div style="font-size:12px;"><b>Firma responsable de farmacia</b></div>
          <div style="height:34px; border-bottom:1px solid #bbb;"></div>
          <div style="font-size:12px; color:#444;">Nombre y firma</div>
        </div>
        <div>
          <div style="font-size:12px;"><b>Firma coordinaci√≥n de capacitaci√≥n</b></div>
          <div style="height:34px; border-bottom:1px solid #bbb;"></div>
          <div style="font-size:12px; color:#444;">Lic. Cecilia √Åvila</div>
        </div>
      </div>
    </div>
  </div>
</dialog>

<!-- FOLLOW DIALOG -->
<dialog id="dlgFollow" class="no-print">
  <div class="dlg-hd">
    <div style="font-weight:900">Nuevo seguimiento</div>
    <button class="btn" id="btnCloseFollow">‚úñÔ∏è Cerrar</button>
  </div>
  <div class="dlg-bd">
    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="fDate" type="date" />
      </div>
      <div>
        <label>Tipo</label>
        <select id="fType">
          <option>Avance</option>
          <option>Evidencia</option>
          <option>Visita</option>
          <option>Capacitaci√≥n</option>
          <option>Observaci√≥n</option>
          <option>Cierre</option>
        </select>
      </div>
    </div>
    <label>Nota</label>
    <textarea id="fNote" placeholder="Ej: Se reforz√≥ cierre con menci√≥n de facturaci√≥n. Evidencia en carpeta."></textarea>
    <div class="hr"></div>
    <button class="btn ok" id="btnSaveFollow">‚úÖ Guardar</button>
  </div>
</dialog>

<!-- HELP DIALOG -->
<dialog id="dlgHelp" class="no-print">
  <div class="dlg-hd">
    <div style="font-weight:900">Ayuda r√°pida</div>
    <button class="btn" id="btnCloseHelp">‚úñÔ∏è Cerrar</button>
  </div>
  <div class="dlg-bd">
    <div class="hint" style="font-size:13px;">
      <p><b>1) Offline</b>: Guarda en tu navegador. Para moverlo a otra PC: <b>Exportar JSON</b> ‚Üí <b>Importar</b>.</p>
      <p><b>2) Evaluaci√≥n</b>: Marca S√≠/No y se calcula el puntaje (0‚Äì100) autom√°ticamente.</p>
      <p><b>3) Sem√°foro</b>: Rojo si hay pendientes o vencidas; Amarillo si hay seguimiento; Verde si todo est√° cerrado.</p>
      <p><b>4) Acta</b>: Abre una sesi√≥n ‚Üí <b>Acta</b> ‚Üí ‚ÄúGuardar como PDF‚Äù.</p>
      <p><b>GitHub</b>: Subes <span class="mono">index.html</span> y activas Pages (main / root).</p>
    </div>
  </div>
</dialog>

<script>
  const CONFIG = {
    sucursales: [
      "Chihuahua 95","Ju√°rez 30","Ju√°rez 10","Ju√°rez 49","Ju√°rez 63","Ju√°rez 97",
      "Ju√°rez 101","Ju√°rez 102","Ju√°rez 119","Rivera Lara","Valle del Sol",
      "Otra (especificar en observaciones)"
    ],
    evalItems: [
      { id:"agenda",  label:"Se realiz√≥ capacitaci√≥n programada conforme a agenda", w:10 },
      { id:"obj",     label:"Se explicaron objetivos claros de la sesi√≥n", w:5 },
      { id:"material",label:"Se utiliz√≥ material oficial ALPACEL / Simiescuela", w:5 },
      { id:"claro",   label:"La capacitaci√≥n fue comprensible para todo el personal", w:10 },
      { id:"pno",     label:"Se reforzaron pol√≠ticas y PNO aplicables", w:10 },
      { id:"indic",   label:"Se relacion√≥ la capacitaci√≥n con indicadores (PCP/CEPIP/Impulso)", w:10 },
      { id:"dudas",   label:"Se resolvieron dudas del personal", w:5 },
      { id:"retro",   label:"Se realiz√≥ retroalimentaci√≥n individual", w:10 },
      { id:"oport",   label:"Se identificaron √°reas de oportunidad del equipo", w:10 },
      { id:"comp",    label:"Se dejaron compromisos claros al cierre", w:10 },
      { id:"seg",     label:"Se dio seguimiento a compromisos previos", w:10 },
      { id:"part",    label:"El personal mostr√≥ participaci√≥n activa", w:5 }
    ]
  };

  const KEY = "alpacel_agenda_capacitacion_v1";
  const nowISO = () => new Date().toISOString();
  const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  const todayYMD = () => new Date().toISOString().slice(0,10);

  function loadData(){ try{ const r = localStorage.getItem(KEY); return r? JSON.parse(r): []; }catch{ return []; } }
  function saveData(a){ localStorage.setItem(KEY, JSON.stringify(a)); }

  let items = loadData();
  let activeId = null;

  const $ = (id)=>document.getElementById(id);
  const esc = (s)=> (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  function fmt(d){ if(!d) return "‚Äî"; try{ const [y,m,day]=d.split("-"); return `${day}/${m}/${y}`;}catch{ return d; } }

  function fillSelect(sel, arr, placeholder){
    sel.innerHTML = "";
    if(placeholder){ const op=document.createElement("option"); op.value=""; op.textContent=placeholder; sel.appendChild(op); }
    arr.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
  }
  fillSelect($("farmacia"), CONFIG.sucursales, "Selecciona sucursal‚Ä¶");
  fillSelect($("dFarmacia"), CONFIG.sucursales, "");

  $("fecha").value = todayYMD();
  $("hini").value = "09:00";
  $("hfin").value = "17:00";

  function scoreFromEval(evalObj){
    let s=0;
    CONFIG.evalItems.forEach(it=>{ if(evalObj?.[it.id]===true) s+=it.w; });
    return s;
  }
  function levelFromScore(score){
    if(score>=90) return "Excelente";
    if(score>=80) return "Bueno";
    if(score>=70) return "Regular";
    return "Deficiente";
  }
  function isOverdueSession(it){
    if(!it.fechaComp) return false;
    if(it.estatus==="Cerrada") return false;
    return new Date(it.fechaComp) < new Date(todayYMD());
  }
  function semaforoCounts(group){
    const overdue = group.filter(isOverdueSession).length;
    const pending = group.filter(x=> x.estatus==="Programada" || x.estatus==="Impartida").length;
    const follow  = group.filter(x=> x.estatus==="En seguimiento").length;
    if(overdue>0 || pending>0) return {cls:"bad", label:"Rojo"};
    if(follow>0) return {cls:"warn", label:"Amarillo"};
    return {cls:"ok", label:"Verde"};
  }

  function renderEvalGrid(){
    const host = $("evalGrid");
    host.innerHTML = `
      <table class="table">
        <tr><th>Punto a evaluar</th><th style="width:130px;">Cumple</th><th style="width:120px;">Ponderaci√≥n</th></tr>
        ${CONFIG.evalItems.map(it=>`
          <tr>
            <td>${esc(it.label)}</td>
            <td>
              <select data-evalid="${esc(it.id)}" class="evalSel">
                <option value="1">S√≠</option>
                <option value="0" selected>No</option>
              </select>
            </td>
            <td><span class="badge b-info">${it.w}</span></td>
          </tr>
        `).join("")}
      </table>
      <div class="hint" style="margin-top:10px;">Ponderaci√≥n total: <b>100</b>.</div>
    `;
    host.querySelectorAll(".evalSel").forEach(sel=> sel.addEventListener("input", updateLiveScore));
    updateLiveScore();
  }
  renderEvalGrid();

  function collectEvalFromGrid(){
    const obj = {};
    document.querySelectorAll(".evalSel").forEach(sel=>{
      obj[sel.getAttribute("data-evalid")] = (sel.value==="1");
    });
    return obj;
  }
  function updateLiveScore(){ $("scoreNow").textContent = scoreFromEval(collectEvalFromGrid()); }

  // Form
  $("btnNew").addEventListener("click", ()=>{ clearForm(); $("farmacia").focus(); });
  $("btnClear").addEventListener("click", clearForm);

  $("form").addEventListener("submit", (e)=>{
    e.preventDefault();
    const evalObj = collectEvalFromGrid();
    const score = scoreFromEval(evalObj);
    const entry = {
      id: uid(),
      farmacia: $("farmacia").value.trim(),
      fecha: $("fecha").value,
      hini: $("hini").value,
      hfin: $("hfin").value,
      modalidad: $("modalidad").value,
      capacitador: ($("capacitador").value.trim() || "Lic. Cecilia √Åvila"),
      tipo: $("tipo").value,
      temas: $("temas").value.trim(),
      personal: $("personal").value.trim(),
      evidencia: $("evidencia").value.trim(),
      estatus: $("estatus").value,
      fechaComp: $("fechaComp").value || "",
      impacto: $("impacto").value.trim(),
      eval: evalObj,
      score,
      level: levelFromScore(score),
      obs: $("obs").value.trim(),
      compromisos: $("compromisos").value.trim(),
      follow: [],
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
    items.unshift(entry);
    saveData(items);
    clearForm();
    render();
  });

  function clearForm(){
    $("farmacia").value="";
    $("fecha").value=todayYMD();
    $("hini").value="09:00";
    $("hfin").value="17:00";
    $("modalidad").value="Presencial";
    $("capacitador").value="Lic. Cecilia √Åvila";
    $("tipo").value="Refuerzo";
    $("temas").value="";
    $("personal").value="";
    $("evidencia").value="";
    $("estatus").value="Programada";
    $("fechaComp").value="";
    $("impacto").value="";
    $("obs").value="";
    $("compromisos").value="";
    document.querySelectorAll(".evalSel").forEach(sel=> sel.value="0");
    updateLiveScore();
  }

  // Filters
  const q = $("q"), fEstatus = $("fEstatus"), sortBy = $("sortBy"), fromDate=$("fromDate"), toDate=$("toDate"), viewMode=$("viewMode");
  [q,fEstatus,sortBy,fromDate,toDate,viewMode].forEach(el=> el.addEventListener("input", render));

  function applyFilters(){
    const query = q.value.trim().toLowerCase();
    const st = fEstatus.value;
    const fd = fromDate.value;
    const td = toDate.value;
    return items.filter(it=>{
      const hay = [it.farmacia,it.temas,it.personal,it.capacitador,it.tipo,it.estatus,it.obs,it.compromisos,it.evidencia,it.impacto].join(" ").toLowerCase();
      if(query && !hay.includes(query)) return false;
      if(st && it.estatus!==st) return false;
      if(fd && it.fecha && it.fecha<fd) return false;
      if(td && it.fecha && it.fecha>td) return false;
      return true;
    });
  }
  function applySort(arr){
    const a = arr.slice();
    const s = sortBy.value;
    if(s==="updated_desc") a.sort((x,y)=> (y.updatedAt||"").localeCompare(x.updatedAt||""));
    else if(s==="date_desc") a.sort((x,y)=> (y.fecha||"").localeCompare(x.fecha||""));
    else if(s==="date_asc") a.sort((x,y)=> (x.fecha||"").localeCompare(y.fecha||""));
    else if(s==="score_desc") a.sort((x,y)=> (y.score||0)-(x.score||0));
    else if(s==="farmacia") a.sort((x,y)=> (x.farmacia||"").localeCompare(y.farmacia||""));
    return a;
  }

  function statusBadgeCls(st){
    if(st==="Cerrada") return "b-ok";
    if(st==="En seguimiento") return "b-warn";
    if(st==="Impartida") return "b-info";
    return "b-bad";
  }

  function renderKPIs(filtered){
    const total=filtered.length;
    const prog=filtered.filter(x=>x.estatus==="Programada").length;
    const imp=filtered.filter(x=>x.estatus==="Impartida").length;
    const seg=filtered.filter(x=>x.estatus==="En seguimiento").length;
    const cer=filtered.filter(x=>x.estatus==="Cerrada").length;
    const venc=filtered.filter(isOverdueSession).length;
    const avg= total ? Math.round(filtered.reduce((s,x)=> s+(x.score||0),0)/total) : 0;
    $("kpis").innerHTML = `
      <div class="kpi"><div class="t">Total</div><div class="n">${total}</div></div>
      <div class="kpi"><div class="t">Programadas ‚Ä¢ Impartidas</div><div class="n">${prog} ‚Ä¢ ${imp}</div></div>
      <div class="kpi"><div class="t">Seguimiento ‚Ä¢ Vencidas</div><div class="n">${seg} ‚Ä¢ ${venc}</div></div>
      <div class="kpi"><div class="t">Cerradas ‚Ä¢ Promedio</div><div class="n">${cer} ‚Ä¢ ${avg}</div></div>
    `;
  }

  function renderFarmTable(filtered){
    const by = new Map();
    CONFIG.sucursales.forEach(s=> by.set(s, []));
    filtered.forEach(it=>{
      const k = it.farmacia || "‚Äî";
      if(!by.has(k)) by.set(k, []);
      by.get(k).push(it);
    });

    const rows = Array.from(by.entries()).map(([farm, arr])=>{
      const sem = semaforoCounts(arr);
      const overdue = arr.filter(isOverdueSession).length;
      const pending = arr.filter(x=> x.estatus==="Programada" || x.estatus==="Impartida").length;
      const follow  = arr.filter(x=> x.estatus==="En seguimiento").length;
      const closed  = arr.filter(x=> x.estatus==="Cerrada").length;
      const avg = arr.length ? Math.round(arr.reduce((s,x)=> s+(x.score||0),0)/arr.length) : 0;
      return {farm, sem, overdue, pending, follow, closed, total:arr.length, avg};
    }).filter(r=> r.total>0 || CONFIG.sucursales.includes(r.farm))
      .sort((a,b)=>{
        const rank={bad:1,warn:2,ok:3};
        if(rank[a.sem.cls]!==rank[b.sem.cls]) return rank[a.sem.cls]-rank[b.sem.cls];
        return b.total-a.total;
      });

    $("farmTable").innerHTML = `
      <table class="table">
        <tr><th>Sem√°foro</th><th>Farmacia</th><th>Total</th><th>Pendientes</th><th>Seguimiento</th><th>Cerradas</th><th>Vencidas</th><th>Promedio</th><th>Acci√≥n</th></tr>
        ${rows.map(r=>`
          <tr>
            <td><span class="pill ${r.sem.cls}"><span class="bar"></span>${r.sem.label}</span></td>
            <td>${esc(r.farm)}</td><td>${r.total}</td><td>${r.pending}</td><td>${r.follow}</td><td>${r.closed}</td><td>${r.overdue}</td>
            <td><span class="badge b-pink">${r.avg}</span></td>
            <td><button class="btn primary" onclick="filterFarm('${esc(r.farm).replaceAll("'","&#039;")}')">Ver</button></td>
          </tr>
        `).join("")}
      </table>
    `;
  }
  window.filterFarm = function(f){ q.value=f; render(); $("list").scrollIntoView({behavior:"smooth", block:"start"}); };

  function renderCards(filtered){
    $("list").className="list";
    $("list").innerHTML = filtered.map(it=>{
      const overdue = isOverdueSession(it);
      const temas = (it.temas||"");
      return `
        <div class="item" onclick="openDetail('${it.id}')">
          <div>
            <h3>${esc(it.farmacia||"Sin farmacia")} ‚Äî <span class="muted">${esc(it.tipo||"")}</span></h3>
            <div class="meta">
              <span class="badge ${statusBadgeCls(it.estatus)}">${esc(it.estatus)}</span>
              <span class="badge b-pink">Puntaje: ${it.score ?? 0}/100</span>
              <span class="badge b-info">${esc(it.level || levelFromScore(it.score||0))}</span>
              <span class="badge">Fecha: ${fmt(it.fecha)}</span>
              <span class="badge ${overdue ? "b-bad" : ""}">Compromiso: ${it.fechaComp ? fmt(it.fechaComp) : "‚Äî"}${overdue ? " ‚ö†Ô∏è" : ""}</span>
              <span class="badge">Capacitador: ${esc(it.capacitador||"")}</span>
            </div>
            <div class="hint" style="margin-top:10px; white-space:pre-wrap">${esc(temas.slice(0,160) + (temas.length>160 ? "‚Ä¶" : ""))}</div>
          </div>
          <div class="actions">
            <span class="badge">Abrir</span>
            <span class="hint" style="text-align:right">${new Date(it.updatedAt).toLocaleString()}</span>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderTable(filtered){
    $("list").className="";
    $("list").innerHTML = `
      <table class="table">
        <tr><th>Estatus</th><th>Puntaje</th><th>Nivel</th><th>Farmacia</th><th>Fecha</th><th>Compromiso</th><th>Tipo</th><th>Capacitador</th><th>Temas</th></tr>
        ${filtered.map(it=>{
          const overdue=isOverdueSession(it);
          const temas=(it.temas||"");
          return `
            <tr onclick="openDetail('${it.id}')" style="cursor:pointer;">
              <td><span class="badge ${statusBadgeCls(it.estatus)}">${esc(it.estatus)}</span></td>
              <td><span class="badge b-pink">${it.score ?? 0}</span></td>
              <td><span class="badge b-info">${esc(it.level || levelFromScore(it.score||0))}</span></td>
              <td>${esc(it.farmacia||"")}</td>
              <td>${fmt(it.fecha)}</td>
              <td><span class="badge ${overdue ? "b-bad":""}">${it.fechaComp ? fmt(it.fechaComp):"‚Äî"}${overdue?" ‚ö†Ô∏è":""}</span></td>
              <td>${esc(it.tipo||"")}</td>
              <td>${esc(it.capacitador||"")}</td>
              <td>${esc(temas.slice(0,80) + (temas.length>80 ? "‚Ä¶" : ""))}</td>
            </tr>
          `;
        }).join("")}
      </table>
      <div class="hint" style="margin-top:10px;">Tip: da clic en una fila para abrir el detalle.</div>
    `;
  }

  // Detail dialog
  const dlg = $("dlg"), dlgFollow=$("dlgFollow"), dlgHelp=$("dlgHelp");
  $("dlgClose").addEventListener("click", ()=> dlg.close());
  $("btnHelp").addEventListener("click", ()=> dlgHelp.showModal());
  $("btnCloseHelp").addEventListener("click", ()=> dlgHelp.close());

  $("btnAddFollow").addEventListener("click", ()=>{
    $("fDate").value=todayYMD(); $("fType").value="Avance"; $("fNote").value="";
    dlgFollow.showModal();
  });
  $("btnCloseFollow").addEventListener("click", ()=> dlgFollow.close());
  $("btnSaveFollow").addEventListener("click", saveFollow);

  $("btnSave").addEventListener("click", saveDetail);
  $("btnDelete").addEventListener("click", deleteDetail);
  $("btnPrint").addEventListener("click", printActa);

  function openDetail(id){
    const it = items.find(x=>x.id===id); if(!it) return;
    activeId=id;
    $("dlgTitle").textContent = `${it.farmacia||"Sin farmacia"} ‚Äî ${it.tipo||""}`;
    $("dlgSub").textContent = `Fecha: ${fmt(it.fecha)} ‚Ä¢ √öltima actualizaci√≥n: ${new Date(it.updatedAt).toLocaleString()}`;

    $("dEstatus").value=it.estatus;
    $("dFechaComp").value=it.fechaComp||"";
    $("dCapacitador").value=it.capacitador||"Lic. Cecilia √Åvila";
    $("dFarmacia").value=it.farmacia||"";
    $("dTipo").value=it.tipo||"Refuerzo";
    $("dFecha").value=it.fecha||"";
    $("dHini").value=it.hini||"";
    $("dHfin").value=it.hfin||"";
    $("dTemas").value=it.temas||"";
    $("dPersonal").value=it.personal||"";
    $("dEvidencia").value=it.evidencia||"";
    $("dObs").value=it.obs||"";
    $("dImpacto").value=it.impacto||"";
    $("dScore").value=`${it.score ?? 0}/100 (${it.level || levelFromScore(it.score||0)})`;
    $("dCompromisos").value=it.compromisos||"";

    renderFollowList(it);
    hideActa();
    dlg.showModal();
  }
  window.openDetail = openDetail;

  function renderFollowList(it){
    const host=$("followList"); const f=it.follow||[];
    if(f.length===0){ host.innerHTML=`<div class="hint">Sin seguimiento a√∫n. Agrega una nota hoy y se vuelve real.</div>`; return; }
    host.innerHTML = f.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||"")).map((x,i)=>`
      <div class="follow-entry">
        <div class="meta">
          <span class="badge b-info">${fmt(x.date)}</span>
          <span class="badge">${esc(x.type)}</span>
          <span class="badge">${i+1}/${f.length}</span>
        </div>
        <div style="margin-top:8px; white-space:pre-wrap">${esc(x.note)}</div>
        <div style="margin-top:10px; display:flex; justify-content:flex-end;">
          <button class="btn danger" onclick="removeFollow('${it.id}','${x.id}')">üóëÔ∏è Quitar</button>
        </div>
      </div>
    `).join("");
  }

  window.removeFollow = function(itemId, followId){
    const it=items.find(x=>x.id===itemId); if(!it) return;
    it.follow=(it.follow||[]).filter(f=>f.id!==followId);
    it.updatedAt=nowISO(); saveData(items);
    renderFollowList(it); render();
  }

  function saveFollow(){
    const it=items.find(x=>x.id===activeId); if(!it) return;
    const date=$("fDate").value; const type=$("fType").value; const note=$("fNote").value.trim();
    if(!date || !note){ alert("Pon fecha y nota. Sin eso, no hay seguimiento."); return; }
    it.follow=it.follow||[]; it.follow.push({id:uid(), date, type, note});
    it.updatedAt=nowISO();
    if(type==="Cierre") it.estatus="Cerrada";
    saveData(items);
    dlgFollow.close();
    renderFollowList(it); render();
  }

  function saveDetail(){
    const it=items.find(x=>x.id===activeId); if(!it) return;
    it.estatus=$("dEstatus").value;
    it.fechaComp=$("dFechaComp").value||"";
    it.capacitador=($("dCapacitador").value.trim()||"Lic. Cecilia √Åvila");
    it.farmacia=$("dFarmacia").value||it.farmacia;
    it.tipo=$("dTipo").value||it.tipo;
    it.fecha=$("dFecha").value||it.fecha;
    it.hini=$("dHini").value||it.hini;
    it.hfin=$("dHfin").value||it.hfin;
    it.temas=$("dTemas").value.trim();
    it.personal=$("dPersonal").value.trim();
    it.evidencia=$("dEvidencia").value.trim();
    it.obs=$("dObs").value.trim();
    it.impacto=$("dImpacto").value.trim();
    it.compromisos=$("dCompromisos").value.trim();
    it.updatedAt=nowISO();
    saveData(items);
    dlg.close();
    render();
  }

  function deleteDetail(){
    const it=items.find(x=>x.id===activeId); if(!it) return;
    if(!confirm("¬øEliminar esta sesi√≥n? Esto no se puede deshacer.")) return;
    items=items.filter(x=>x.id!==activeId);
    saveData(items);
    activeId=null;
    dlg.close();
    render();
  }

  // Export/Import
  $("btnExport").addEventListener("click", exportJSON);
  $("btnExportCSV").addEventListener("click", exportCSV);
  $("importFile").addEventListener("change", importJSON);
  $("btnWipe").addEventListener("click", wipeAll);

  function exportJSON(){
    const data={app:"ALPACEL Agenda de Capacitaci√≥n", version:1, exportedAt: nowISO(), items};
    const blob=new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=`ALPACEL_agenda_capacitacion_${todayYMD()}.json`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function exportCSV(){
    const cols=["id","farmacia","fecha","hini","hfin","modalidad","capacitador","tipo","estatus","fechaComp","score","level","impacto","temas","personal","evidencia","obs","compromisos","seguimientos","updatedAt"];
    const lines=[cols.join(",")];
    items.forEach(it=>{
      const row=[it.id,it.farmacia,it.fecha,it.hini,it.hfin,it.modalidad,it.capacitador,it.tipo,it.estatus,it.fechaComp,it.score,it.level,it.impacto,
        (it.temas||"").replaceAll("\n"," "), (it.personal||"").replaceAll("\n"," "), (it.evidencia||"").replaceAll("\n"," "),
        (it.obs||"").replaceAll("\n"," "), (it.compromisos||"").replaceAll("\n"," "), (it.follow||[]).length, it.updatedAt
      ].map(v=>`"${(v??"").toString().replaceAll('"','""')}"`);
      lines.push(row.join(","));
    });
    const blob=new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download=`ALPACEL_agenda_capacitacion_${todayYMD()}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function importJSON(ev){
    const file=ev.target.files?.[0]; if(!file) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const data=JSON.parse(r.result);
        const incoming=Array.isArray(data) ? data : (data.items||[]);
        if(!Array.isArray(incoming)) throw new Error("Formato inv√°lido");
        const map=new Map(items.map(x=>[x.id,x]));
        incoming.forEach(it=>{
          if(!it.id) it.id=uid();
          it.follow=it.follow||[];
          it.updatedAt=it.updatedAt||nowISO();
          it.createdAt=it.createdAt||nowISO();
          if(typeof it.score!=="number") it.score=scoreFromEval(it.eval||{});
          it.level=it.level||levelFromScore(it.score||0);
          map.set(it.id,it);
        });
        items=Array.from(map.values());
        saveData(items);
        render();
        alert("Importaci√≥n lista ‚úÖ");
      }catch(e){
        alert("No se pudo importar: "+e.message);
      }finally{ ev.target.value=""; }
    };
    r.readAsText(file,"utf-8");
  }

  function wipeAll(){
    if(!confirm("¬øBorrar TODO? Esto elimina los registros del navegador.")) return;
    items=[]; saveData(items); render();
  }

  // Acta print
  function showActa(){ $("acta").style.display="block"; }
  function hideActa(){ $("acta").style.display="none"; }

  function printActa(){
    const it=items.find(x=>x.id===activeId); if(!it) return;
    $("aToday").textContent=new Date().toLocaleString();
    $("aFolio").textContent=it.id;
    $("aFarm").textContent=it.farmacia||"‚Äî";
    $("aFecha").textContent=fmt(it.fecha);
    $("aHora").textContent=`${it.hini||"‚Äî"} a ${it.hfin||"‚Äî"}`;
    $("aMod").textContent=it.modalidad||"‚Äî";
    $("aTipo").textContent=it.tipo||"‚Äî";
    $("aStatus").textContent=it.estatus||"‚Äî";
    $("aTemas").textContent=it.temas||"‚Äî";
    $("aPersonal").textContent=it.personal||"‚Äî";
    $("aEvi").textContent=it.evidencia||"‚Äî";
    $("aObs").textContent=it.obs||"‚Äî";
    $("aComp").textContent=it.compromisos||"‚Äî";
    $("aScore").textContent=`${it.score ?? 0}/100 (${it.level || levelFromScore(it.score||0)})`;
    $("aImpacto").textContent=it.impacto||"‚Äî";
    $("aFcomp").textContent=it.fechaComp ? fmt(it.fechaComp) : "‚Äî";
    $("aFcount").textContent=(it.follow||[]).length;

    const tbl=$("aFollowTbl");
    tbl.innerHTML=`<tr><th>#</th><th>Fecha</th><th>Tipo</th><th>Nota</th></tr>`;
    const f=(it.follow||[]).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
    if(f.length===0){
      const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="4">Sin seguimiento registrado</td>`; tbl.appendChild(tr);
    }else{
      f.forEach((x,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${fmt(x.date)}</td><td>${esc(x.type)}</td><td>${esc(x.note)}</td>`;
        tbl.appendChild(tr);
      });
    }
    showActa();
    setTimeout(()=>{ window.print(); setTimeout(hideActa, 250); }, 100);
  }

  // Help buttons in dialogs
  $("btnCloseHelp").addEventListener("click", ()=> dlgHelp.close());
  $("btnCloseFollow").addEventListener("click", ()=> dlgFollow.close());

  // Main render
  function render(){
    const filtered=applySort(applyFilters());
    renderKPIs(filtered);
    renderFarmTable(filtered);

    if(filtered.length===0){
      $("list").innerHTML=`<div class="hint">Sin registros con esos filtros. O est√°s muy zen, o filtraste demasiado. üòå</div>`;
      return;
    }
    if(viewMode.value==="table") renderTable(filtered);
    else renderCards(filtered);
  }

  render();
</script>
</body>
</html>
