<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ALPACEL ‚Äî Agenda de Capacitaci√≥n (Zonas & Reporte)</title>
  <meta name="description" content="Agenda de capacitaci√≥n ALPACEL: sesiones, evaluaci√≥n 0‚Äì100, compromisos, sem√°foro, reporte estilo Saltillo (APP/PCP/PXN/%BATEO + indicadores) y cobertura por zonas."/>
  <meta name="theme-color" content="#0b0f1a"/>
  <style>
    :root{
      --bg:#070018;
      --panel:#0f1527;
      --panel2:#0b1020;
      --text:#f5f7ff;
      --muted:rgba(245,247,255,.72);
      --line:rgba(255,255,255,.12);

      --pink:#ff2bd6;
      --cyan:#00e5ff;
      --lime:#b7ff00;
      --orange:#ff8a00;
      --red:#ff3b3b;
      --green:#22ff88;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1000px 700px at 15% 10%, rgba(255,43,214,.26), transparent 60%),
        radial-gradient(900px 650px at 85% 15%, rgba(0,229,255,.22), transparent 60%),
        radial-gradient(1000px 700px at 55% 90%, rgba(183,255,0,.16), transparent 60%),
        linear-gradient(180deg, #070018, #0b0a2a 55%, #050014);
      color:var(--text);
      letter-spacing:.2px;
    }
    a{color:inherit}
    .wrap{max-width:1260px;margin:0 auto;padding:18px 16px 72px}
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter: blur(12px);
      background: rgba(8,4,30,.55);
      border-bottom:1px solid var(--line);
    }
    .top{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;
      padding:16px 0;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:46px;height:46px;border-radius:16px;
      background: conic-gradient(from 210deg, var(--pink), var(--cyan), var(--lime), var(--orange), var(--pink));
      box-shadow: var(--shadow);
      display:grid;place-items:center;
      font-weight:900;color:#0b0030;user-select:none;letter-spacing:.5px;
    }
    .brand h1{margin:0;font-size:18px;line-height:1.1}
    .brand p{margin:4px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,.btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 16px;
      cursor:pointer;
      transition:.18s ease;
      display:inline-flex; gap:8px; align-items:center;
      text-decoration:none;
      user-select:none;
    }
    button:hover,.btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    button.primary{border-color: rgba(0,229,255,.45); background: rgba(0,229,255,.14)}
    button.danger{border-color: rgba(255,59,59,.45); background: rgba(255,59,59,.12)}
    button.pink{border-color: rgba(255,43,214,.45); background: rgba(255,43,214,.12)}
    button.small{padding:8px 10px;border-radius:14px;font-size:12px}
    input,select,textarea{
      width:100%;
      padding:10px 12px;border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);outline:none;
    }
    textarea{min-height:86px;resize:vertical}
    input::placeholder,textarea::placeholder{color:rgba(245,247,255,.55)}
    label{display:block;font-size:12px;color:var(--muted);margin:6px 2px 6px}
    .hint{font-size:12px;color:var(--muted);line-height:1.45}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px;margin-top:16px}
    @media (min-width: 1040px){ .grid{grid-template-columns: 480px 1fr} }
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:14px 14px 10px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    }
    .bd{padding:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.14);
      font-weight:900;font-size:12px;color:var(--muted);
    }
    .tab.active{color:var(--text);border-color:rgba(0,229,255,.55);background:rgba(0,229,255,.12)}
    .row{display:grid;gap:10px}
    .row.two{grid-template-columns:1fr 1fr}
    .row.three{grid-template-columns:1fr 1fr 1fr}
    .row.four{grid-template-columns:1fr 1fr 1fr 1fr}
    @media (max-width:720px){ .row.two,.row.three,.row.four{grid-template-columns:1fr} }
    .hr{height:1px;background:var(--line);margin:12px 0}
    .kpiGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:1000px){ .kpiGrid{grid-template-columns:repeat(2,1fr)} }
    .kpi{
      padding:12px;border-radius:18px;border:1px solid var(--line);background:rgba(0,0,0,.16)
    }
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .n{font-size:20px;font-weight:900;margin-top:6px}
    .badge{
      font-size:11px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.06);white-space:nowrap;
    }
    .b-ok{border-color: rgba(34,255,136,.45); background: rgba(34,255,136,.10)}
    .b-warn{border-color: rgba(255,138,0,.50); background: rgba(255,138,0,.10)}
    .b-bad{border-color: rgba(255,59,59,.50); background: rgba(255,59,59,.10)}
    .b-info{border-color: rgba(0,229,255,.55); background: rgba(0,229,255,.10)}
    .b-pink{border-color: rgba(255,43,214,.55); background: rgba(255,43,214,.10)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      display:inline-flex;gap:8px;align-items:center;
    }
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.g{background:var(--green)} .dot.y{background:var(--orange)} .dot.r{background:var(--red)} .dot.c{background:var(--cyan)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 20px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      transition:.18s ease;
    }
    .item:hover{transform: translateY(-1px); background: rgba(0,0,0,.22)}
    .item h3{margin:0;font-size:14px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .table{
      width:100%;
      border-collapse:separate;border-spacing:0;
      overflow:hidden;border-radius:18px;border:1px solid var(--line);
      background: rgba(0,0,0,.14);
    }
    .table th,.table td{padding:10px;border-bottom:1px solid var(--line);font-size:12px;text-align:left;vertical-align:top}
    .table th{color:var(--muted);font-weight:800;background:rgba(255,255,255,.04)}
    .table tr:last-child td{border-bottom:none}
    dialog{
      border:none;border-radius:22px;width:min(980px, 94vw);
      background:linear-gradient(180deg, rgba(16,10,50,.96), rgba(6,0,28,.96));
      color:var(--text);box-shadow:var(--shadow);
    }
    dialog::backdrop{background: rgba(0,0,0,.62)}
    .dlg-hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .dlg-bd{padding:14px}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.55);border:1px solid var(--line);
      padding:10px 12px;border-radius:999px;backdrop-filter: blur(10px);
      color:var(--text);font-size:12px;opacity:0;pointer-events:none;
      transition:opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}
    .printNote{font-size:12px;color:var(--muted)}
    .printable{
      background:#fff;color:#111;border-radius:16px;padding:18px;border:1px solid #ddd;
    }
    .printable h1{font-size:18px;margin:0 0 6px}
    .printable h2{font-size:12px;margin:12px 0 6px;color:#222}
    .printable .sig{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .printable .sig div{border-top:1px solid #888;padding-top:8px;font-size:12px}
    @media print{
      #acta{display:block !important}
      .noPrint{display:none !important}

      body{background:#fff;color:#111}
      header,.noPrint{display:none !important}
      dialog{position:static;box-shadow:none;width:100%}
      dialog::backdrop{display:none}
      .table{border-color:#ddd;background:#fff}
      .table th,.table td{border-color:#ddd;color:#111}
    }
  </style>
</head>
<body>
<header class="noPrint">
  <div class="wrap top">
    <div class="brand">
      <div class="logo">C</div>
      <div>
        <h1>ALPACEL ‚Äî Agenda de Capacitaci√≥n</h1>
        <p>
          Registro & seguimiento con <b>Reporte estilo Saltillo</b> + <b>cobertura por zonas</b>.<br/>
          <span class="muted">Hecho por: <b>Lic. Cecilia √Åvila</b> ‚Ä¢ Coordinaci√≥n de Capacitaci√≥n</span>
        </p>
      </div>
    </div>
    <div class="toolbar">
      <button class="primary" id="btnNew">‚ûï Nueva sesi√≥n</button>
      <button id="btnExport">‚¨áÔ∏è Exportar JSON</button>
      <label class="btn" for="fileImport" style="margin:0;cursor:pointer">‚¨ÜÔ∏è Importar JSON</label>
      <input id="fileImport" type="file" accept="application/json" style="display:none">
      <button class="danger" id="btnWipe">üßπ Borrar todo</button>
      <button class="pink" id="btnHelp">‚ùì Ayuda</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT -->
    <section class="card noPrint">
      <div class="hd">
        <div>
          <div style="font-weight:900">Registro de sesi√≥n</div>
          <div class="hint">Tradici√≥n: disciplina. Futuro: datos. Y s√≠: la evidencia manda.</div>
        </div>
        <div class="tabs">
          <button class="tab active" data-tab="basico">B√°sico</button>
          <button class="tab" data-tab="reporte">Reporte</button>
          <button class="tab" data-tab="zonas">Zonas</button>
        </div>
      </div>
      <div class="bd">
        <!-- TAB BASICO -->
        <div id="tab_basico">
          <div class="row two">
            <div>
              <label>Zona / Regi√≥n</label>
              <input id="f_zone" placeholder="Ej. Ju√°rez / Saltillo / Chihuahua / Celaya">
            </div>
            <div>
              <label>Farmacia / Sucursal</label>
              <input id="f_store" placeholder="Ej. JU√ÅREZ 30 / RIVERA LARA">
            </div>
          </div>

          <div class="row two">
            <div>
              <label>Fecha</label>
              <input id="f_date" type="date">
            </div>
            <div>
              <label>Encargado(a) / Responsable</label>
              <input id="f_manager" placeholder="Nombre del encargado(a)">
            </div>
          </div>

          <div class="row three">
            <div>
              <label>Hora de interacci√≥n</label>
              <input id="f_interaction" type="time">
            </div>
            <div>
              <label>Inicio</label>
              <input id="f_start" type="time">
            </div>
            <div>
              <label>Fin</label>
              <input id="f_end" type="time">
            </div>
          </div>

          <div class="row two">
            <div>
              <label>Modalidad</label>
              <select id="f_mode">
                <option>Presencial</option>
                <option>Mixta</option>
                <option>Remota</option>
              </select>
            </div>
            <div>
              <label>Capacitador(a)</label>
              <input id="f_trainer" value="Lic. Cecilia √Åvila">
            </div>
          </div>

          <div class="row two">
            <div>
              <label>Tipo de capacitaci√≥n</label>
              <select id="f_type">
                <option>Inducci√≥n</option>
                <option selected>Refuerzo</option>
                <option>Correctiva</option>
                <option>Indicadores</option>
                <option>Sanitaria</option>
                <option>Operativa</option>
              </select>
            </div>
            <div>
              <label>Estatus</label>
              <select id="f_status">
                <option selected>Programada</option>
                <option>Impartida</option>
                <option>En seguimiento</option>
                <option>Cerrada</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Tema(s) tratados</label>
              <textarea id="f_topics" placeholder="Ej: Protocolo de atenci√≥n, CEPIP, impulso, PNO..."></textarea>
            </div>
          </div>

          <div class="row two">
            <div>
              <label>Personal capacitado (nombres)</label>
              <textarea id="f_people" placeholder="Ej: Miriam, Juan, Paty..."></textarea>
            </div>
            <div>
              <label>Evidencia (link / nota)</label>
              <textarea id="f_evidence" placeholder="Drive / Simiescuela / formato firmado..."></textarea>
            </div>
          </div>

          <div class="row three">
            <div>
              <label>Fecha compromiso</label>
              <input id="f_due" type="date">
            </div>
            <div>
              <label>Impacto esperado</label>
              <input id="f_impact" placeholder="Ej: Mejorar PCP, subir CEPIP...">
            </div>
            <div>
              <label>Folio (opcional)</label>
              <input id="f_folio" placeholder="Ej. SAL-2025-12-001">
            </div>
          </div>

          <div class="hr"></div>

          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
            <div>
              <div style="font-weight:900">Evaluaci√≥n de la sesi√≥n (0‚Äì100)</div>
              <div class="hint">Marca ‚ÄúS√≠/No‚Äù. Puntaje autom√°tico.</div>
            </div>
            <div class="chip"><span class="dot c"></span><b>Puntaje:</b> <span id="scoreNow">0</span>/100</div>
          </div>

          <div class="hr"></div>
          <div id="evalGrid"></div>

          <div class="hr"></div>
          <label>Observaciones del capacitador</label>
          <textarea id="f_obs" placeholder="Hechos, evidencia y acci√≥n. Corto y contundente."></textarea>

          <label>Compromisos (uno por l√≠nea)</label>
          <textarea id="f_commit" placeholder="1) ...&#10;2) ...&#10;3) ..."></textarea>
          <div class="hr"></div>

          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
            <div>
              <div style="font-weight:900">Reporte dentro de la Informaci√≥n B√°sica</div>
              <div class="hint">Aqu√≠ ves el reporte tipo Saltillo sin salir de esta secci√≥n. Se actualiza en autom√°tico con lo capturado en <b>Reporte</b>.</div>
            </div>
            <button class="small" type="button" id="btnGoReport">‚û°Ô∏è Ir a Reporte</button>
          </div>

          <div id="repSummary" class="hint" style="margin-top:10px"></div>

          <div style="margin-top:10px;overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:52px">No.</th>
                  <th>Nombre</th>
                  <th style="width:90px">APP</th>
                  <th style="width:90px">PCP</th>
                  <th style="width:90px">PXN</th>
                  <th style="width:110px">% BATEO</th>
                </tr>
              </thead>
              <tbody id="repTraineePreview"></tbody>
            </table>
          </div>

          
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:16px">
            <div>
              <div style="font-weight:900">Seguimiento de farmacia ‚Äî Indicadores</div>
              <div class="hint">Opci√≥n A: indicadores fijos (PCP, CEPIP, Impulso, Venta total, Presupuesto). T√∫ capturas Meta/Proyecci√≥n/Alcance.</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="small" id="btnRestoreInd">‚ôªÔ∏è Restaurar indicadores</button>
              <button class="small" id="btnClearInd">üßπ Limpiar n√∫meros</button>
            </div>
          </div>

<div style="margin-top:10px;overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Indicador</th>
                  <th style="width:140px">Meta</th>
                  <th style="width:140px">Proyecci√≥n</th>
                  <th style="width:140px">Alcance</th>
                  <th style="width:120px">Sem√°foro</th>
                </tr>
              </thead>
              <tbody id="repIndicatorPreview"></tbody>
            </table>
          </div>

          <div class="row two" style="margin-top:10px">
            <div>
              <label>Colaborador (reporte)</label>
              <input id="repCollabPreview" readonly>
            </div>
            <div>
              <label>Compromisos del colaborador (reporte)</label>
              <textarea id="repCollabCommitPreview" readonly></textarea>
            </div>
          </div>


          <div class="hr"></div>
          <div class="hr"></div>
          <div style="font-weight:900">Seguimiento de farmacia (√∫ltimas notas)</div>
          <div class="hint">Aqu√≠ se ven tus notas de seguimiento de la sesi√≥n seleccionada. Si es una sesi√≥n nueva, saldr√° vac√≠o.</div>
          <div id="repFollowPreview" class="hint" style="margin-top:10px"></div>

          <div class="row two">
            <button class="primary" id="btnSave">‚úÖ Guardar sesi√≥n</button>
            <button id="btnClear">üßº Limpiar</button>
          </div>

          <p class="hint">Si no qued√≥ escrito, fue un ‚Äúme acord√© tantito‚Äù‚Ä¶ y eso no cuenta. üòå</p>
        </div>

        <!-- TAB REPORTE -->
        <div id="tab_reporte" style="display:none">
          <div class="hint">Formato inspirado en el <b>Reporte de Capacitaci√≥n en farmacia</b> (Saltillo): personal con APP/PCP/PXN/%BATEO + indicadores Meta/Proyecci√≥n/Alcance + compromisos.</div>
          <div class="hr"></div>

          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div style="font-weight:900">Personal ‚Äî APP / PCP / PXN / % BATEO</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="small" id="btnAddTrainee">‚ûï Agregar fila</button>
              <button class="small" id="btnResetTrainee">‚Ü©Ô∏è Limpiar tabla</button>
            </div>
          </div>
          <div style="margin-top:10px;overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th style="width:52px">No.</th>
                  <th>Nombre</th>
                  <th style="width:90px">APP</th>
                  <th style="width:90px">PCP</th>
                  <th style="width:90px">PXN</th>
                  <th style="width:110px">% BATEO</th>
                  <th style="width:56px"></th>
                </tr>
              </thead>
              <tbody id="traineeBody"></tbody>
            </table>
          </div>

          <div class="hr"></div>

          <div style="font-weight:900">Seguimiento de farmacia ‚Äî Indicadores</div>
          <div class="hint">Meta vs Proyecci√≥n vs Alcance. Aqu√≠ se ve el avance real.</div>
          <div style="margin-top:10px;overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Indicador</th>
                  <th style="width:140px">Meta</th>
                  <th style="width:140px">Proyecci√≥n</th>
                  <th style="width:140px">Alcance</th>
                </tr>
              </thead>
              <tbody id="indBody"></tbody>
            </table>
          </div>

          <div class="hr"></div>

          <div style="font-weight:900">Compromisos del colaborador</div>
          <div class="row two" style="margin-top:10px">
            <div>
              <label>Nombre</label>
              <input id="c_name" placeholder="Nombre del colaborador">
            </div>
            <div>
              <label>Compromisos (uno por l√≠nea)</label>
              <textarea id="c_list" placeholder="1) ...&#10;2) ..."></textarea>
            </div>
          </div>

          <div class="hr"></div>
          <button class="primary" id="btnSaveReport">‚úÖ Guardar Reporte dentro de la sesi√≥n</button>

          <div class="hr"></div>
          <button id="btnPrintActa">üñ®Ô∏è Acta / Reporte (imprimir / PDF)</button>
          <div class="printNote">Tip: abre el acta y usa ‚ÄúGuardar como PDF‚Äù. Formato limpio para auditor√≠a y juntas.</div>
        </div>

        <!-- TAB ZONAS -->
        <div id="tab_zonas" style="display:none">
          <div class="hint">Cobertura por zonas: para visitar TODO ALPACEL sin dejar huecos.</div>
          <div class="hr"></div>

          <div class="row two">
            <div>
              <label>Ventana de cobertura</label>
              <select id="cov_window">
                <option value="30">√öltimos 30 d√≠as</option>
                <option value="45">√öltimos 45 d√≠as</option>
                <option value="60">√öltimos 60 d√≠as</option>
                <option value="90">√öltimos 90 d√≠as</option>
              </select>
            </div>
            <div>
              <label>Objetivo de cobertura (por zona)</label>
              <select id="cov_goal">
                <option value="100">100% (ideal)</option>
                <option value="85">85% (realista)</option>
                <option value="70">70% (m√≠nimo)</option>
              </select>
            </div>
          </div>

          <div class="hr"></div>

          <label>Zonas y farmacias (padr√≥n editable)</label>
          <textarea id="zones_text" placeholder="Formato: ZONA | Farmacia 1, Farmacia 2, ...&#10;Ej: JU√ÅREZ | JU√ÅREZ 30, JU√ÅREZ 10, RIVERA LARA"></textarea>
          <div class="row two" style="margin-top:10px">
            <button class="primary" id="btnSaveZones">üíæ Guardar padr√≥n</button>
            <button id="btnUseInferred">‚ú® Usar inferido (de tus sesiones)</button>
          </div>

          <div class="hr"></div>
          <div id="covSummary" class="list"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card noPrint">
      <div class="hd">
        <div>
          <div style="font-weight:900">Agenda & seguimiento</div>
          <div class="hint">Busca, filtra, abre sesi√≥n y dale continuidad. Con m√©todo.</div>
        </div>
        <div class="chips">
          <span class="chip"><span class="dot g"></span>Cerrada</span>
          <span class="chip"><span class="dot y"></span>Seguimiento</span>
          <span class="chip"><span class="dot r"></span>Pendiente</span>
        </div>
      </div>
      <div class="bd">
        <div class="kpiGrid" id="kpis"></div>
        <div class="hr"></div>

        <div class="row three">
          <div>
            <label>Buscar</label>
            <input id="q" placeholder="Zona, farmacia, temas, personal...">
          </div>
          <div>
            <label>Estatus</label>
            <select id="q_status">
              <option value="">Todos</option>
              <option>Programada</option>
              <option>Impartida</option>
              <option>En seguimiento</option>
              <option>Cerrada</option>
            </select>
          </div>
          <div>
            <label>Ordenar</label>
            <select id="q_sort">
              <option value="updated_desc" selected>√öltima actualizaci√≥n</option>
              <option value="date_desc">Fecha (desc)</option>
              <option value="date_asc">Fecha (asc)</option>
              <option value="score_desc">Puntaje (alto‚Üíbajo)</option>
              <option value="store_asc">Farmacia (A‚ÜíZ)</option>
              <option value="zone_asc">Zona (A‚ÜíZ)</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>
        <div id="list" class="list"></div>

        <div class="hint" style="margin-top:14px">ALPACEL ‚Ä¢ Capacitaci√≥n con evidencia ‚Ä¢ La costumbre buena se vuelve sistema ‚Ä¢ Y el sistema, futuro.</div>
      </div>
    </section>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- DETAIL DIALOG -->
<dialog id="dlg">
  <div class="dlg-hd noPrint">
    <div>
      <div id="dlgTitle" style="font-weight:900" class="mono">Detalle</div>
      <div class="hint" id="dlgSub"></div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="small primary" id="btnActa">üñ®Ô∏è Acta/Reporte</button>
      <button class="small danger" id="btnDelete">üóëÔ∏è Eliminar</button>
      <button class="small" id="btnCloseDlg">‚úñÔ∏è Cerrar</button>
    </div>
  </div>
  <div class="dlg-bd">
    <div class="row two noPrint">
      <div>
        <label>Estatus</label>
        <select id="d_status">
          <option>Programada</option>
          <option>Impartida</option>
          <option>En seguimiento</option>
          <option>Cerrada</option>
        </select>
      </div>
      <div>
        <label>Fecha compromiso</label>
        <input id="d_due" type="date">
      </div>
    </div>

    <div class="row two noPrint" style="margin-top:10px">
      <div>
        <label>Zona</label>
        <input id="d_zone">
      </div>
      <div>
        <label>Farmacia</label>
        <input id="d_store">
      </div>
    </div>

    <div class="row four noPrint" style="margin-top:10px">
      <div>
        <label>Fecha</label>
        <input id="d_date" type="date">
      </div>
      <div>
        <label>Inicio</label>
        <input id="d_start" type="time">
      </div>
      <div>
        <label>Fin</label>
        <input id="d_end" type="time">
      </div>
      <div>
        <label>Modalidad</label>
        <select id="d_mode">
          <option>Presencial</option>
          <option>Mixta</option>
          <option>Remota</option>
        </select>
      </div>
    </div>

    <div class="row three noPrint" style="margin-top:10px">
      <div>
        <label>Encargado(a)</label>
        <input id="d_manager">
      </div>
      <div>
        <label>Hora interacci√≥n</label>
        <input id="d_interaction" type="time">
      </div>
      <div>
        <label>Folio</label>
        <input id="d_folio">
      </div>
    </div>

    <div class="row two noPrint" style="margin-top:10px">
      <div>
        <label>Tipo</label>
        <select id="d_type">
          <option>Inducci√≥n</option>
          <option>Refuerzo</option>
          <option>Correctiva</option>
          <option>Indicadores</option>
          <option>Sanitaria</option>
          <option>Operativa</option>
        </select>
      </div>
      <div>
        <label>Capacitador(a)</label>
        <input id="d_trainer">
      </div>
    </div>

    <div class="row two noPrint" style="margin-top:10px">
      <div>
        <label>Temas</label>
        <textarea id="d_topics"></textarea>
      </div>
      <div>
        <label>Personal</label>
        <textarea id="d_people"></textarea>
      </div>
    </div>

    <div class="row two noPrint">
      <div>
        <label>Evidencia</label>
        <textarea id="d_evidence"></textarea>
      </div>
      <div>
        <label>Observaciones</label>
        <textarea id="d_obs"></textarea>
      </div>
    </div>

    <div class="row two noPrint">
      <div>
        <label>Impacto esperado</label>
        <input id="d_impact">
      </div>
      <div>
        <label>Puntaje</label>
        <input id="d_score" readonly>
      </div>
    </div>

    <label class="noPrint">Compromisos</label>
    <textarea class="noPrint" id="d_commit"></textarea>

    <div class="hr noPrint"></div>
    <button class="primary noPrint" id="btnSaveDetail">üíæ Guardar cambios</button>

    <!-- Printable Acta -->
    <div id="acta" class="printable" style="margin-top:14px;display:none">
      <h1>ALPACEL ‚Äî Acta / Reporte de Capacitaci√≥n</h1>
      <div class="muted" style="font-size:12px;margin-bottom:10px">Coordinaci√≥n de Capacitaci√≥n ‚Ä¢ Evidencia ‚Ä¢ Compromisos ‚Ä¢ Seguimiento</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:12px">
        <div><b>Capacitador(a):</b> <span id="a_trainer"></span></div>
        <div><b>Folio:</b> <span id="a_folio"></span></div>
        <div><b>Zona:</b> <span id="a_zone"></span></div>
        <div><b>Farmacia:</b> <span id="a_store"></span></div>
        <div><b>Encargado(a):</b> <span id="a_manager"></span></div>
        <div><b>Fecha:</b> <span id="a_date"></span></div>
        <div><b>Horario:</b> <span id="a_time"></span></div>
        <div><b>Modalidad:</b> <span id="a_mode"></span></div>
        <div><b>Tipo:</b> <span id="a_type"></span></div>
        <div><b>Estatus:</b> <span id="a_status"></span></div>
        <div><b>Hora interacci√≥n:</b> <span id="a_interaction"></span></div>
        <div><b>Puntaje:</b> <span id="a_score"></span></div>
      </div>

      <h2>Temas</h2>
      <div id="a_topics" style="white-space:pre-wrap;font-size:12px"></div>

      <h2>Personal</h2>
      <div id="a_people" style="white-space:pre-wrap;font-size:12px"></div>

      <h2>Evidencia</h2>
      <div id="a_evidence" style="white-space:pre-wrap;font-size:12px"></div>

      <h2>Observaciones</h2>
      <div id="a_obs"></div>

      <h2>Compromisos</h2>
      <div id="a_commit"></div>

      <h2>Reporte ‚Äî Personal (APP/PCP/PXN/%Bateo)</h2>
      <div style="overflow:auto">
        <table class="table" style="border:1px solid #ddd;background:#fff">
          <thead>
            <tr>
              <th style="color:#222;background:#f4f4f4">No.</th>
              <th style="color:#222;background:#f4f4f4">Nombre</th>
              <th style="color:#222;background:#f4f4f4">APP</th>
              <th style="color:#222;background:#f4f4f4">PCP</th>
              <th style="color:#222;background:#f4f4f4">PXN</th>
              <th style="color:#222;background:#f4f4f4">% BATEO</th>
            </tr>
          </thead>
          <tbody id="a_trainees"></tbody>
        </table>
      </div>

      <h2>Seguimiento de farmacia ‚Äî Indicadores</h2>
      <div style="overflow:auto">
        <table class="table" style="border:1px solid #ddd;background:#fff">
          <thead>
            <tr>
              <th style="color:#222;background:#f4f4f4">Indicador</th>
              <th style="color:#222;background:#f4f4f4">Meta</th>
              <th style="color:#222;background:#f4f4f4">Proyecci√≥n</th>
              <th style="color:#222;background:#f4f4f4">Alcance</th>
            </tr>
          </thead>
          <tbody id="a_inds"></tbody>
        </table>
      </div>

      <h2>Compromisos del colaborador</h2>
      <div style="font-size:12px"><b>Nombre:</b> <span id="a_cname"></span></div>
      <ul id="a_clist" style="font-size:12px"></ul>

      <div class="sig">
        <div>Firma responsable de farmacia<br><span class="muted">Nombre y firma</span></div>
        <div>Firma coordinaci√≥n de capacitaci√≥n<br><span class="muted">Lic. Cecilia √Åvila</span></div>
      </div>
    </div>
  </div>
</dialog>

<!-- HELP -->
<dialog id="help" class="noPrint">
  <div class="dlg-hd">
    <div style="font-weight:900">Ayuda r√°pida</div>
    <button class="small" id="btnCloseHelp">‚úñÔ∏è Cerrar</button>
  </div>
  <div class="dlg-bd" style="font-size:13px;color:var(--muted);line-height:1.55">
    <p style="margin-top:0"><b>Offline</b>: se guarda en tu navegador (LocalStorage). Para moverlo a otra PC: <b>Exportar JSON</b> ‚Üí <b>Importar JSON</b>.</p>
    <ol style="margin:0;padding-left:18px">
      <li><b>B√°sico</b>: registra zona/farmacia, temas, personal, evidencia, compromisos.</li>
      <li><b>Reporte</b>: captura personal (APP/PCP/PXN/%BATEO), indicadores (Meta/Proyecci√≥n/Alcance) y compromisos del colaborador.</li>
      <li><b>Acta/Reporte</b>: abre una sesi√≥n y usa üñ®Ô∏è para imprimir o guardar PDF.</li>
      <li><b>Zonas</b>: pega tu padr√≥n ‚ÄúZONA | lista de farmacias‚Äù para medir cobertura por ventana de d√≠as.</li>
    </ol>
    <p>Tip: lo que no est√° en datos, no existe üòå</p>
  </div>
</dialog>

<script>
(() => {
  const LS_KEY = "alpacel_agenda_cap_v3";
  const ZONES_KEY = "alpacel_zones_registry_v1";
  const $ = (id) => document.getElementById(id);

  const toast = (msg) => {
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1600);
  };

  const CONFIG = {
    evalItems: [
      { id:"agenda",  label:"Se realiz√≥ capacitaci√≥n programada conforme a agenda", w:10 },
      { id:"obj",     label:"Se explicaron objetivos claros de la sesi√≥n", w:5 },
      { id:"material",label:"Se utiliz√≥ material oficial ALPACEL / Simiescuela", w:5 },
      { id:"claro",   label:"La capacitaci√≥n fue comprensible para todo el personal", w:10 },
      { id:"pno",     label:"Se reforzaron pol√≠ticas y PNO aplicables", w:10 },
      { id:"indic",   label:"Se relacion√≥ la capacitaci√≥n con indicadores (PCP/CEPIP/Impulso)", w:10 },
      { id:"dudas",   label:"Se resolvieron dudas del personal", w:5 },
      { id:"retro",   label:"Se realiz√≥ retroalimentaci√≥n individual", w:10 },
      { id:"oport",   label:"Se identificaron √°reas de oportunidad del equipo", w:10 },
      { id:"comp",    label:"Se dejaron compromisos claros al cierre", w:10 },
      { id:"seg",     label:"Se dio seguimiento a compromisos previos", w:10 },
      { id:"part",    label:"El personal mostr√≥ participaci√≥n activa", w:5 }
    ],
    indicatorOptions: ["Venta total","Presupuesto","PCP","CEPIP","Impulso"],
    defaultIndicators: [
      {name:"Venta total", meta:"", proj:"", alc:""},
      {name:"Presupuesto", meta:"", proj:"", alc:""},
      {name:"PCP", meta:"", proj:"", alc:""},
      {name:"CEPIP", meta:"", proj:"", alc:""},
      {name:"Impulso", meta:"", proj:"", alc:""},
    ]
  };

  const nowISO = () => new Date().toISOString();
  const todayYMD = () => new Date().toISOString().slice(0,10);
  const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

  const state = { sessions: [], currentId: null };

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      state.sessions = raw ? (JSON.parse(raw) || []) : [];
    }catch{ state.sessions = []; }
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state.sessions)); }

  function loadZonesText(){ return localStorage.getItem(ZONES_KEY) || ""; }
  function saveZonesText(t){ localStorage.setItem(ZONES_KEY, t || ""); }

  function scoreFromEval(evalObj){
    let s=0;
    CONFIG.evalItems.forEach(it => { if(evalObj && evalObj[it.id]===true) s += it.w; });
    return s;
  }
  function levelFromScore(score){
    if(score>=90) return "Excelente";
    if(score>=80) return "Bueno";
    if(score>=70) return "Regular";
    return "Deficiente";
  }

  function fmtDate(d){
    if(!d) return "‚Äî";
    try{ return new Date(d+"T00:00:00").toLocaleDateString("es-MX"); }catch{ return d; }
  }

  function isOverdue(s){
    if(!s.due) return false;
    if(s.status==="Cerrada") return false;
    const due = new Date(s.due+"T00:00:00");
    const today = new Date(todayYMD()+"T00:00:00");
    return due < today;
  }

  function statusClass(s){
    if(s.status==="Cerrada") return "b-ok";
    if(s.status==="En seguimiento") return "b-warn";
    if(s.status==="Impartida") return "b-info";
    return "b-bad";
  }

  // Tabs
  function ensureIndicatorsReady(){
    const body = document.getElementById("indBody");
    if(body && body.children.length===0) setIndicators(CONFIG.defaultIndicators);
  }

  function setTab(name){
    ensureIndicatorsReady();
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab===name));
    $("tab_basico").style.display = name==="basico" ? "" : "none";
    $("tab_reporte").style.display = name==="reporte" ? "" : "none";
    $("tab_zonas").style.display = name==="zonas" ? "" : "none";
    if(name==="zonas") renderCoverage();
    if(name==="basico") renderReportPreview();
  }
  document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", ()=> setTab(t.dataset.tab)));

  // Evaluation grid
  function renderEvalGrid(){
    const host = $("evalGrid");
    host.innerHTML = `
      <table class="table">
        <tr><th>Punto a evaluar</th><th style="width:130px;">Cumple</th><th style="width:120px;">Ponderaci√≥n</th></tr>
        ${CONFIG.evalItems.map(it=>`
          <tr>
            <td>${escapeHtml(it.label)}</td>
            <td>
              <select data-evalid="${escapeHtml(it.id)}" class="evalSel">
                <option value="1">S√≠</option>
                <option value="0" selected>No</option>
              </select>
            </td>
            <td><span class="badge b-info">${it.w}</span></td>
          </tr>
        `).join("")}
      </table>
      <div class="hint" style="margin-top:10px;">Ponderaci√≥n total: <b>100</b>.</div>
    `;
    host.querySelectorAll(".evalSel").forEach(sel => sel.addEventListener("input", updateLiveScore));
    updateLiveScore();
  }
  function collectEval(){
    const obj = {};
    document.querySelectorAll(".evalSel").forEach(sel => obj[sel.dataset.evalid] = (sel.value==="1"));
    return obj;
  }
  function setEval(evalObj){
    document.querySelectorAll(".evalSel").forEach(sel => {
      const id = sel.dataset.evalid;
      sel.value = (evalObj && evalObj[id]) ? "1" : "0";
    });
    updateLiveScore();
  }
  function updateLiveScore(){
    $("scoreNow").textContent = scoreFromEval(collectEval());
  }

  // Report tables
  function addTraineeRow(data=null){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="t_no" style="width:100%" value="${escapeAttr(data?.no||"")}"></td>
      <td><input class="t_name" style="width:100%" value="${escapeAttr(data?.name||"")}"></td>
      <td><input class="t_app" style="width:100%" value="${escapeAttr(data?.app||"")}"></td>
      <td><input class="t_pcp" style="width:100%" value="${escapeAttr(data?.pcp||"")}"></td>
      <td><input class="t_pxn" style="width:100%" value="${escapeAttr(data?.pxn||"")}"></td>
      <td><input class="t_bateo" style="width:100%" value="${escapeAttr(data?.bateo||"")}"></td>
      <td><button class="small danger t_del" title="Eliminar">‚úï</button></td>
    `;
    tr.querySelector(".t_del").addEventListener("click", ()=> tr.remove());
    $("traineeBody").appendChild(tr);
  }
  function readTrainees(){
    const rows = [];
    document.querySelectorAll("#traineeBody tr").forEach(tr => {
      const get=(sel)=> tr.querySelector(sel)?.value?.trim() || "";
      const r = {no:get(".t_no"), name:get(".t_name"), app:get(".t_app"), pcp:get(".t_pcp"), pxn:get(".t_pxn"), bateo:get(".t_bateo")};
      if(Object.values(r).some(v=>v)) rows.push(r);
    });
    return rows;
  }
  function setTrainees(arr){
    $("traineeBody").innerHTML = "";
    (arr && arr.length ? arr : []).forEach(r => addTraineeRow(r));
    if(!arr || arr.length===0) addTraineeRow();
  }

  function setIndicators(arr){
    $("indBody").innerHTML = "";
    (arr && arr.length ? arr : CONFIG.defaultIndicators).forEach(r => addIndicatorRow(r));
  }
  function addIndicatorRow(r){
    const tr = document.createElement("tr");
    const opts = (CONFIG.indicatorOptions || []).map(o=> `<option ${o=== (r?.name||"") ? "selected":""}>${escapeHTML(o)}</option>`).join("");
    tr.innerHTML = `
      <td>
        <select class="i_name" style="width:100%">
          ${opts}
        </select>
      </td>
      <td><input class="i_meta" inputmode="decimal" style="width:100%" value="${escapeAttr(r?.meta||"")}"></td>
      <td><input class="i_proj" inputmode="decimal" style="width:100%" value="${escapeAttr(r?.proj||"")}"></td>
      <td><input class="i_alc"  inputmode="decimal" style="width:100%" value="${escapeAttr(r?.alc||"")}"></td>
    `;
    $("indBody").appendChild(tr);
  }
  function readIndicators(){
    const rows = [];
    document.querySelectorAll("#indBody tr").forEach(tr => {
      const get=(sel)=> tr.querySelector(sel)?.value?.trim() || "";
      const r = {name:get(".i_name"), meta:get(".i_meta"), proj:get(".i_proj"), alc:get(".i_alc")};
      if(r.name) rows.push(r);
    });
    return rows.length ? rows : CONFIG.defaultIndicators;
  }

  // Form helpers
  function clearForm(){
    state.currentId = null;
    $("f_zone").value = "";
    $("f_store").value = "";
    $("f_date").value = todayYMD();
    $("f_manager").value = "";
    $("f_interaction").value = "";
    $("f_start").value = "09:00";
    $("f_end").value = "17:00";
    $("f_mode").value = "Presencial";
    $("f_trainer").value = "Lic. Cecilia √Åvila";
    $("f_type").value = "Refuerzo";
    $("f_status").value = "Programada";
    $("f_topics").value = "";
    $("f_people").value = "";
    $("f_evidence").value = "";
    $("f_due").value = "";
    $("f_impact").value = "";
    $("f_folio").value = "";
    $("f_obs").value = "";
    $("f_commit").value = "";
    setEval({});
    setTrainees([]);
    setIndicators(CONFIG.defaultIndicators);
    $("c_name").value = "";
    $("c_list").value = "";
  }

  function upsertSession(s){
    const idx = state.sessions.findIndex(x => x.id===s.id);
    if(idx>=0){
      s.createdAt = state.sessions[idx].createdAt || s.updatedAt;
      state.sessions[idx] = s;
    } else {
      s.createdAt = s.updatedAt;
      state.sessions.unshift(s);
    }
    save();
  }

  function currentSessionFromForm(){
    const ev = collectEval();
    const score = scoreFromEval(ev);
    return {
      id: state.currentId || uid(),
      zone: $("f_zone").value.trim(),
      store: $("f_store").value.trim(),
      date: $("f_date").value,
      manager: $("f_manager").value.trim(),
      interaction: $("f_interaction").value,
      start: $("f_start").value,
      end: $("f_end").value,
      mode: $("f_mode").value,
      trainer: $("f_trainer").value.trim() || "Lic. Cecilia √Åvila",
      type: $("f_type").value,
      status: $("f_status").value,
      topics: $("f_topics").value.trim(),
      people: $("f_people").value.trim(),
      evidence: $("f_evidence").value.trim(),
      due: $("f_due").value,
      impact: $("f_impact").value.trim(),
      folio: $("f_folio").value.trim(),
      obs: $("f_obs").value.trim(),
      commit: $("f_commit").value.trim(),
      eval: ev,
      score,
      level: levelFromScore(score),
      report: {
        trainees: readTrainees(),
        indicators: readIndicators(),
        collaborator: {
          name: $("c_name").value.trim(),
          commitments: $("c_list").value.trim()
        }
      },
      updatedAt: nowISO(),
      createdAt: null
    };
  }

  function fillForm(s){
    state.currentId = s.id;
    $("f_zone").value = s.zone || "";
    $("f_store").value = s.store || "";
    $("f_date").value = s.date || todayYMD();
    $("f_manager").value = s.manager || "";
    $("f_interaction").value = s.interaction || "";
    $("f_start").value = s.start || "";
    $("f_end").value = s.end || "";
    $("f_mode").value = s.mode || "Presencial";
    $("f_trainer").value = s.trainer || "Lic. Cecilia √Åvila";
    $("f_type").value = s.type || "Refuerzo";
    $("f_status").value = s.status || "Programada";
    $("f_topics").value = s.topics || "";
    $("f_people").value = s.people || "";
    $("f_evidence").value = s.evidence || "";
    $("f_due").value = s.due || "";
    $("f_impact").value = s.impact || "";
    $("f_folio").value = s.folio || "";
    $("f_obs").value = s.obs || "";
    $("f_commit").value = s.commit || "";
    setEval(s.eval || {});
    setTrainees(s.report?.trainees || []);
    setIndicators(s.report?.indicators || CONFIG.defaultIndicators);
    $("c_name").value = s.report?.collaborator?.name || "";
    $("c_list").value = s.report?.collaborator?.commitments || "";
    updateLiveScore();
  }

  // Rendering
  function renderKPIs(list){
    const total=list.length;
    const prog=list.filter(x=>x.status==="Programada").length;
    const imp=list.filter(x=>x.status==="Impartida").length;
    const seg=list.filter(x=>x.status==="En seguimiento").length;
    const cer=list.filter(x=>x.status==="Cerrada").length;
    const venc=list.filter(isOverdue).length;
    const avg= total ? Math.round(list.reduce((s,x)=> s+(x.score||0),0)/total) : 0;

    $("kpis").innerHTML = `
      <div class="kpi"><div class="t">Total</div><div class="n">${total}</div></div>
      <div class="kpi"><div class="t">Programadas ‚Ä¢ Impartidas</div><div class="n">${prog} ‚Ä¢ ${imp}</div></div>
      <div class="kpi"><div class="t">Seguimiento ‚Ä¢ Vencidas</div><div class="n">${seg} ‚Ä¢ ${venc}</div></div>
      <div class="kpi"><div class="t">Cerradas ‚Ä¢ Promedio</div><div class="n">${cer} ‚Ä¢ ${avg}</div></div>
    `;
  }

  function renderList(){
    const q = $("q").value.trim().toLowerCase();
    const st = $("q_status").value;
    const sort = $("q_sort").value;

    let items = [...state.sessions];

    if(st) items = items.filter(s => (s.status||"")===st);

    if(q){
      items = items.filter(s => {
        const blob = [s.zone,s.store,s.topics,s.people,s.trainer,s.manager,s.type,s.status,s.folio,
          s.report?.collaborator?.name||"", s.report?.collaborator?.commitments||""
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    const by = {
      updated_desc:(a,b)=> (b.updatedAt||"").localeCompare(a.updatedAt||""),
      date_desc:(a,b)=> (b.date||"").localeCompare(a.date||""),
      date_asc:(a,b)=> (a.date||"").localeCompare(b.date||""),
      score_desc:(a,b)=> (b.score||0)-(a.score||0),
      store_asc:(a,b)=> (a.store||"").localeCompare(b.store||""),
      zone_asc:(a,b)=> (a.zone||"").localeCompare(b.zone||""),
    }[sort] || ((a,b)=>0);
    items.sort(by);

    renderKPIs(items);

    const host = $("list");
    host.innerHTML = "";
    if(items.length===0){
      host.innerHTML = `<div class="hint">Sin registros con esos filtros. O est√°s muy zen, o filtraste demasiado üòå</div>`;
      return;
    }

    items.forEach(s => {
      const overdue = isOverdue(s);
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <h3>${escapeHtml(s.store||"Sin farmacia")} <span class="muted">(${escapeHtml(s.zone||"s/z")})</span></h3>
          <div class="meta">
            <span class="badge ${statusClass(s)}">${escapeHtml(s.status||"‚Äî")}</span>
            <span class="badge b-pink">Puntaje: ${(s.score??0)}/100</span>
            <span class="badge b-info">${escapeHtml(s.level||levelFromScore(s.score||0))}</span>
            <span class="badge">Fecha: ${fmtDate(s.date)}</span>
            <span class="badge ${overdue ? "b-bad":""}">Compromiso: ${s.due ? fmtDate(s.due):"‚Äî"}${overdue?" ‚ö†Ô∏è":""}</span>
            ${s.folio ? `<span class="badge">Folio: ${escapeHtml(s.folio)}</span>` : ``}
          </div>
          <div class="hint" style="margin-top:10px;white-space:pre-wrap">${escapeHtml((s.topics||"").slice(0,160) + ((s.topics||"").length>160?"‚Ä¶":""))}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <button class="small primary" data-open="${s.id}">Abrir</button>
          <button class="small" data-copy="${s.id}">Duplicar</button>
          <span class="hint" style="text-align:right">${new Date(s.updatedAt).toLocaleString()}</span>
        </div>
      `;
      host.appendChild(el);
    });

    host.querySelectorAll("button[data-open]").forEach(b => b.addEventListener("click", ()=> openDetail(b.dataset.open)));
    host.querySelectorAll("button[data-copy]").forEach(b => b.addEventListener("click", ()=> duplicate(b.dataset.copy)));
  }

  function duplicate(id){
    const s = state.sessions.find(x=>x.id===id);
    if(!s) return;
    const copy = JSON.parse(JSON.stringify(s));
    copy.id = uid();
    copy.status = "Programada";
    copy.updatedAt = nowISO();
    copy.createdAt = copy.updatedAt;
    state.sessions.unshift(copy);
    save();
    renderList();
    toast("Duplicada. Misma base, nueva historia.");
  }

  // Detail dialog
  function openDetail(id){
    const s = state.sessions.find(x=>x.id===id);
    if(!s) return;

    $("dlgTitle").textContent = `${s.store||"Sin farmacia"} ‚Äî ${s.type||""}`;
    $("dlgSub").textContent = `Fecha: ${fmtDate(s.date)} ‚Ä¢ √öltima actualizaci√≥n: ${new Date(s.updatedAt).toLocaleString()}`;

    $("d_status").value = s.status || "Programada";
    $("d_due").value = s.due || "";
    $("d_zone").value = s.zone || "";
    $("d_store").value = s.store || "";
    $("d_date").value = s.date || "";
    $("d_start").value = s.start || "";
    $("d_end").value = s.end || "";
    $("d_mode").value = s.mode || "Presencial";
    $("d_manager").value = s.manager || "";
    $("d_interaction").value = s.interaction || "";
    $("d_folio").value = s.folio || "";
    $("d_type").value = s.type || "Refuerzo";
    $("d_trainer").value = s.trainer || "Lic. Cecilia √Åvila";
    $("d_topics").value = s.topics || "";
    $("d_people").value = s.people || "";
    $("d_evidence").value = s.evidence || "";
    $("d_obs").value = s.obs || "";
    $("d_impact").value = s.impact || "";
    $("d_score").value = `${s.score??0}/100 (${s.level||levelFromScore(s.score||0)})`;
    $("d_commit").value = s.commit || "";

    state.currentId = id;

    // sync left form too (single source)
    fillForm(s);

    $("acta").style.display = "none";
    $("dlg").showModal();
  }

  function updateFromDetail(){
    const s = state.sessions.find(x=>x.id===state.currentId);
    if(!s) return;

    s.status = $("d_status").value;
    s.due = $("d_due").value;
    s.zone = $("d_zone").value.trim();
    s.store = $("d_store").value.trim();
    s.date = $("d_date").value;
    s.start = $("d_start").value;
    s.end = $("d_end").value;
    s.mode = $("d_mode").value;
    s.manager = $("d_manager").value.trim();
    s.interaction = $("d_interaction").value;
    s.folio = $("d_folio").value.trim();
    s.type = $("d_type").value;
    s.trainer = $("d_trainer").value.trim();
    s.topics = $("d_topics").value.trim();
    s.people = $("d_people").value.trim();
    s.evidence = $("d_evidence").value.trim();
    s.obs = $("d_obs").value.trim();
    s.impact = $("d_impact").value.trim();
    s.commit = $("d_commit").value.trim();

    // from left report widgets
    s.eval = collectEval();
    s.score = scoreFromEval(s.eval);
    s.level = levelFromScore(s.score);

    s.report = {
      trainees: readTrainees(),
      indicators: readIndicators(),
      collaborator: { name: $("c_name").value.trim(), commitments: $("c_list").value.trim() }
    };

    s.updatedAt = nowISO();
    save();
    renderList();
  }

  function deleteSession(id){
    state.sessions = state.sessions.filter(s => s.id!==id);
    save();
    renderList();
  }

  // Acta
  function renderActa(){
    const s = state.sessions.find(x=>x.id===state.currentId);
    if(!s) return;

    $("a_trainer").textContent = s.trainer || "‚Äî";
    $("a_folio").textContent = s.folio || s.id;
    $("a_zone").textContent = s.zone || "‚Äî";
    $("a_store").textContent = s.store || "‚Äî";
    $("a_manager").textContent = s.manager || "‚Äî";
    $("a_date").textContent = fmtDate(s.date);
    $("a_time").textContent = `${s.start||"‚Äî"}‚Äì${s.end||"‚Äî"}`;
    $("a_mode").textContent = s.mode || "‚Äî";
    $("a_type").textContent = s.type || "‚Äî";
    $("a_status").textContent = s.status || "‚Äî";
    $("a_interaction").textContent = s.interaction || "‚Äî";
    $("a_score").textContent = `${s.score??0}/100 (${s.level||levelFromScore(s.score||0)})`;

    $("a_topics").textContent = s.topics || "‚Äî";
    $("a_people").textContent = s.people || "‚Äî";
    $("a_evidence").textContent = s.evidence || "‚Äî";
    $("a_obs").textContent = s.obs || "‚Äî";
    $("a_commit").textContent = s.commit || "‚Äî";

    // trainees
    const trB = $("a_trainees");
    trB.innerHTML = "";
    (s.report?.trainees || []).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.no)}</td>
        <td>${escapeHtml(r.name)}</td>
        <td>${escapeHtml(r.app)}</td>
        <td>${escapeHtml(r.pcp)}</td>
        <td>${escapeHtml(r.pxn)}</td>
        <td>${escapeHtml(r.bateo)}</td>`;
      trB.appendChild(tr);
    });
    if(trB.children.length===0) trB.innerHTML = `<tr><td colspan="6">‚Äî</td></tr>`;

    // indicators
    const ib = $("a_inds");
    ib.innerHTML = "";
    (s.report?.indicators || CONFIG.defaultIndicators).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.name)}</td>
        <td>${escapeHtml(r.meta)}</td>
        <td>${escapeHtml(r.proj)}</td>
        <td>${escapeHtml(r.alc)}</td>`;
      ib.appendChild(tr);
    });

    // collaborator commitments
    $("a_cname").textContent = s.report?.collaborator?.name || "‚Äî";
    const ul = $("a_clist");
    ul.innerHTML = "";
    const list = (s.report?.collaborator?.commitments || "").trim().split("\n").map(x=>x.trim()).filter(Boolean);
    if(list.length===0) ul.innerHTML = `<li>‚Äî</li>`;
    else list.forEach(x => { const li=document.createElement("li"); li.textContent=x; ul.appendChild(li); });

    $("acta").style.display = "";
  }

  // Coverage
  function parseZones(text){
    const map = new Map();
    (text||"").split("\n").map(l=>l.trim()).filter(Boolean).forEach(line => {
      const parts = line.split("|");
      if(parts.length<2) return;
      const zone = parts[0].trim();
      const stores = parts.slice(1).join("|").split(",").map(x=>x.trim()).filter(Boolean);
      if(zone) map.set(zone, stores);
    });
    return map;
  }

  function inferZonesFromSessions(){
    const m = new Map();
    state.sessions.forEach(s => {
      const z=(s.zone||"").trim();
      const st=(s.store||"").trim();
      if(!z || !st) return;
      if(!m.has(z)) m.set(z, new Set());
      m.get(z).add(st);
    });
    const out = new Map();
    [...m.entries()].forEach(([z,set])=> out.set(z, [...set].sort((a,b)=>a.localeCompare(b))));
    return out;
  }

  function renderCoverage(){
    const win = parseInt($("cov_window").value,10);
    const goal = parseInt($("cov_goal").value,10);

    const regText = $("zones_text").value.trim();
    const reg = parseZones(regText);
    const inferred = inferZonesFromSessions();
    const zones = reg.size ? reg : inferred;

    const now = new Date();
    const cutoff = new Date(now.getTime() - win*24*60*60*1000);

    const lastVisit = new Map(); // zone|||store -> date
    state.sessions.forEach(s => {
      if(!s.date) return;
      const d = new Date(s.date+"T00:00:00");
      const key = `${(s.zone||"").trim()}|||${(s.store||"").trim()}`;
      const prev = lastVisit.get(key);
      if(!prev || d>prev) lastVisit.set(key, d);
    });

    const host = $("covSummary");
    host.innerHTML = "";

    if(zones.size===0){
      host.innerHTML = `<div class="hint">A√∫n no hay zonas ni sesiones suficientes. Crea sesiones o pega tu padr√≥n.</div>`;
      return;
    }

    const rankColor = (pct)=> pct>=goal ? "b-ok" : (pct>=Math.max(50, goal-15) ? "b-warn" : "b-bad");

    [...zones.entries()].sort((a,b)=>a[0].localeCompare(b[0])).forEach(([zone, stores]) => {
      const total = stores.length || 0;
      let covered = 0;

      const rows = (stores||[]).map(store => {
        const key = `${zone}|||${store}`;
        const d = lastVisit.get(key) || null;
        const inWindow = d && d>=cutoff;
        if(inWindow) covered++;
        const days = d ? Math.floor((now - d)/(24*60*60*1000)) : null;
        const txt = inWindow ? `‚úÖ visitada hace ${days} d√≠a(s)` : (d ? `‚è≥ √∫ltima: hace ${days} d√≠a(s)` : "‚ùå sin visita registrada");
        return {store, d, inWindow, txt};
      });

      const pct = total ? Math.round((covered/total)*100) : 0;
      const cls = rankColor(pct);

      const card = document.createElement("div");
      card.className = "item";
      card.innerHTML = `
        <div>
          <h3>${escapeHtml(zone)}</h3>
          <div class="meta">
            <span class="badge ${cls}">Cobertura ${pct}%</span>
            <span class="badge ${cls}">${covered}/${total} en ${win} d√≠as</span>
            <span class="badge">Meta: ${goal}%</span>
          </div>
          <div style="margin-top:10px;overflow:auto">
            <table class="table">
              <thead><tr><th>Farmacia</th><th>√öltima visita</th><th>Estado</th></tr></thead>
              <tbody>
                ${rows.map(r=>`
                  <tr>
                    <td>${escapeHtml(r.store)}</td>
                    <td>${r.d ? r.d.toLocaleDateString("es-MX") : "‚Äî"}</td>
                    <td><span class="badge ${r.inWindow ? "b-ok" : "b-bad"}">${escapeHtml(r.txt)}</span></td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
          <span class="badge ${cls}">${pct}%</span>
        </div>
      `;
      host.appendChild(card);
    });
  }

  // Export/Import
  function exportJSON(){
    const data = {app:"ALPACEL Agenda de Capacitaci√≥n", version:3, exportedAt: nowISO(), sessions: state.sessions};
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ALPACEL_agenda_capacitacion_${todayYMD()}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSON(ev){
    const file = ev.target.files?.[0];
    if(!file) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const data = JSON.parse(r.result);
        const incoming = Array.isArray(data) ? data : (data.sessions || data.items || []);
        if(!Array.isArray(incoming)) throw new Error("Formato inv√°lido");
        const map = new Map(state.sessions.map(x => [x.id, x]));
        incoming.forEach(s => {
          if(!s.id) s.id = uid();
          s.report = s.report || {trainees:[], indicators:CONFIG.defaultIndicators, collaborator:{name:"", commitments:""}};
          s.eval = s.eval || {};
          s.score = typeof s.score === "number" ? s.score : scoreFromEval(s.eval);
          s.level = s.level || levelFromScore(s.score||0);
          s.updatedAt = s.updatedAt || nowISO();
          s.createdAt = s.createdAt || nowISO();
          map.set(s.id, s);
        });
        state.sessions = Array.from(map.values());
        save();
        renderList();
        toast("Importaci√≥n lista ‚úÖ");
      }catch(e){
        alert("No se pudo importar: " + e.message);
      }finally{
        ev.target.value = "";
      }
    };
    r.readAsText(file,"utf-8");
  }

  function wipeAll(){
    if(!confirm("¬øBorrar TODO? Esto elimina los registros del navegador.")) return;
    state.sessions = [];
    save();
    renderList();
    toast("Listo. Todo limpio.");
  }

  // utils
  function escapeHtml(str){
    return (str||"").toString().replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }
  function escapeHTML(s){ return (s??"").toString().replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
  function escapeAttr(str){ return escapeHtml(str).replace(/"/g,"&quot;"); }

  // Buttons/events
  $("btnNew").addEventListener("click", ()=>{ clearForm(); setTab("basico"); toast("Nueva sesi√≥n."); });
  $("btnClear").addEventListener("click", ()=>{ clearForm(); toast("Limpio."); });

  $("btnSave").addEventListener("click", ()=>{
    const s = currentSessionFromForm();
    upsertSession(s);
    clearForm();
    renderList();
    toast("Guardado ‚úÖ");
  });

  $("btnSaveReport").addEventListener("click", ()=>{
    // ensure there's a session to attach to
    const s = currentSessionFromForm();
    upsertSession(s);
    renderList();
    toast("Reporte guardado ‚úÖ");
  });

  $("btnAddTrainee").addEventListener("click", ()=> { addTraineeRow(); renderReportPreview(); });
  $("btnResetTrainee").addEventListener("click", ()=> { setTrainees([]);
  // Indicadores (Opci√≥n A)
  $("btnRestoreInd") && $("btnRestoreInd").addEventListener("click", ()=>{ setIndicators(CONFIG.defaultIndicators); toast("Indicadores restaurados."); renderReportPreview && renderReportPreview(); });
  $("btnClearInd") && $("btnClearInd").addEventListener("click", ()=>{ 
    document.querySelectorAll("#indBody .i_meta, #indBody .i_proj, #indBody .i_alc").forEach(i=> i.value="");
    toast("N√∫meros limpiados.");
    renderReportPreview && renderReportPreview();
  });
 toast("Tabla limpia."); renderReportPreview(); });

  wireReportPreviewLive();
  renderReportPreview();

  $("btnGoReport") && $("btnGoReport").addEventListener("click", ()=> setTab("reporte"));

  $("q").addEventListener("input", renderList);
  $("q_status").addEventListener("input", renderList);
  $("q_sort").addEventListener("input", renderList);

  $("btnExport").addEventListener("click", exportJSON);
  $("fileImport").addEventListener("change", importJSON);
  $("btnWipe").addEventListener("click", wipeAll);

  $("btnHelp").addEventListener("click", ()=> $("help").showModal());
  $("btnCloseHelp").addEventListener("click", ()=> $("help").close());

  $("btnCloseDlg").addEventListener("click", ()=> $("dlg").close());
  $("btnSaveDetail").addEventListener("click", ()=> { updateFromDetail(); $("dlg").close(); toast("Actualizado ‚úÖ"); });

  $("btnDelete").addEventListener("click", ()=>{
    if(!state.currentId) return;
    if(!confirm("¬øEliminar esta sesi√≥n? Esto no se puede deshacer.")) return;
    deleteSession(state.currentId);
    $("dlg").close();
    toast("Eliminada.");
  });

  $("btnActa").addEventListener("click", ()=>{
    renderActa();
    setTimeout(()=>{ window.print(); }, 350);
  });
  $("btnPrintActa").addEventListener("click", ()=>{
    // Use current session id if exists; otherwise save then print
    const s = currentSessionFromForm();
    upsertSession(s);
    state.currentId = s.id;
    renderList();
    renderActa();
    setTimeout(()=>{ window.print(); /* acta se oculta manualmente si quieres */ }, 100);
  });

  $("btnSaveZones").addEventListener("click", ()=>{
    const t = $("zones_text").value.trim();
    saveZonesText(t);
    toast("Padr√≥n guardado ‚úÖ");
    renderCoverage();
  });
  $("btnUseInferred").addEventListener("click", ()=>{
    const inferred = inferZonesFromSessions();
    if(inferred.size===0){ toast("A√∫n no hay suficiente info para inferir."); return; }
    const lines = [...inferred.entries()].sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([z,stores])=> `${z} | ${stores.join(", ")}`);
    $("zones_text").value = lines.join("\n");
    saveZonesText($("zones_text").value);
    toast("Listo. Padr√≥n inferido ‚ú®");
    renderCoverage();
  });
  $("cov_window").addEventListener("input", renderCoverage);
  $("cov_goal").addEventListener("input", renderCoverage);

  // Init
  load();
  renderEvalGrid();
  clearForm();
  $("zones_text").value = loadZonesText();
  setTrainees([]);
  setIndicators(CONFIG.defaultIndicators);
  renderList();



  // ========== Reporte visible tambi√©n en Informaci√≥n B√°sica ==========
  
  function parseNum(v){
    if(v===null||v===undefined) return NaN;
    const s = (""+v).replace(/[%,$\s]/g,"").replace(",",".");
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }
  function semaforoIndicador(meta, alcance){
    const m = parseNum(meta), a = parseNum(alcance);
    if(!Number.isFinite(m) || m===0 || !Number.isFinite(a)) return {cls:"b-info", txt:"‚Äî"};
    const pct = (a/m)*100;
    if(pct >= 100) return {cls:"b-ok", txt: Math.round(pct)+"%"};
    if(pct >= 85)  return {cls:"b-warn", txt: Math.round(pct)+"%"};
    return {cls:"b-bad", txt: Math.round(pct)+"%"};
  }

  function renderReportPreview(){
    const tBody = document.getElementById("repTraineePreview");
    const iBody = document.getElementById("repIndicatorPreview");
    const sum = document.getElementById("repSummary");
    const cPrev = document.getElementById("repCollabPreview");
    const ccPrev = document.getElementById("repCollabCommitPreview");
    const fPrev = document.getElementById("repFollowPreview");
    if(!tBody || !iBody || !sum || !cPrev || !ccPrev) return;

    // funciones ya existentes en esta app
    const trainees = readTrainees ? readTrainees() : [];
    const inds = readIndicators ? readIndicators() : [];

    const filledT = trainees.filter(r => (r.name||"").trim() || (r.app||"").trim() || (r.pcp||"").trim() || (r.pxn||"").trim() || (r.bateo||"").trim()).length;
    const filledI = inds.filter(r => (r.name||"").trim() || (r.meta||"").trim() || (r.proy||"").trim() || (r.alcan||"").trim()).length;

    const cName = (document.getElementById("c_name")?.value || "").trim();
    const cList = (document.getElementById("c_list")?.value || "").trim();

    cPrev.value = cName || "‚Äî";
    ccPrev.value = cList || "‚Äî";

    sum.innerHTML = `
      <span class="badge">Personal capturado: <b>${filledT}</b></span>
      <span class="badge">Indicadores capturados: <b>${filledI}</b></span>
      <span class="badge">Colaborador: <b>${esc(cName || "‚Äî")}</b></span>
    `;

    
    const fPrev = document.getElementById("repFollowPreview");
    // Seguimiento: solo existe si ya est√°s viendo una sesi√≥n (state.currentId)
    try{
      const sid = (window.state && window.state.currentId) ? window.state.currentId : null;
      const sess = sid && window.state.sessions ? window.state.sessions.find(x=>x.id===sid) : null;
      const fol = (sess && sess.follow) ? sess.follow : [];
      if(!fPrev){} else if(!sess){
        fPrev.innerHTML = "‚Äî";
      }else if(fol.length===0){
        fPrev.innerHTML = "Sin seguimiento registrado a√∫n.";
      }else{
        const last = fol.slice().sort((a,b)=> (a.date||"").localeCompare(b.date||"")).slice(-5);
        fPrev.innerHTML = last.map(x=>`<div class="chip"><span class="dot y"></span><b>${fmtDate(x.date)}</b> ‚Ä¢ ${esc(x.type||"Nota")} ‚Ä¢ ${esc(x.note||"")}</div>`).join("");
      }
    }catch(e){
      if(fPrev) fPrev.innerHTML = "‚Äî";
    }
if(filledT === 0){
      tBody.innerHTML = `<tr><td colspan="6" class="muted">Sin personal capturado a√∫n. (Ve a <b>Reporte</b> y llena la tabla.)</td></tr>`;
    }else{
      tBody.innerHTML = trainees.map((r, idx) => {
        const n = (r.name||"").trim();
        const a = (r.app||"").trim();
        const p = (r.pcp||"").trim();
        const x = (r.pxn||"").trim();
        const b = (r.bateo||"").trim();
        if(!(n||a||p||x||b)) return "";
        return `<tr>
          <td>${idx+1}</td>
          <td>${esc(n||"‚Äî")}</td>
          <td>${esc(a||"‚Äî")}</td>
          <td>${esc(p||"‚Äî")}</td>
          <td>${esc(x||"‚Äî")}</td>
          <td>${esc(b||"‚Äî")}</td>
        </tr>`;
      }).join("") || `<tr><td colspan="6" class="muted">Sin filas v√°lidas.</td></tr>`;
    }

    if(filledI === 0){
      iBody.innerHTML = `<tr><td colspan="5" class="muted">Sin indicadores capturados a√∫n.</td></tr>`;
    }else{
      iBody.innerHTML = inds.map(r => {
        const n = (r.name||"").trim();
        const m = (r.meta||"").trim();
        const pr = (r.proy||"").trim();
        const al = (r.alcan||"").trim();
        if(!(n||m||pr||al)) return "";
        const sem = semaforoIndicador(m, al);
        return `<tr>
          <td>${esc(n||"‚Äî")}</td>
          <td>${esc(m||"‚Äî")}</td>
          <td>${esc(pr||"‚Äî")}</td>
          <td>${esc(al||"‚Äî")}</td>
          <td><span class="badge ${sem.cls}">${sem.txt}</span></td>
        </tr>`;
      }).join("") || `<tr><td colspan="5" class="muted">Sin filas v√°lidas.</td></tr>`;
    }
  }

  function wireReportPreviewLive(){
    const tb = document.getElementById("traineeBody");
    const ib = document.getElementById("indBody");
    tb && tb.addEventListener("input", renderReportPreview);
    ib && ib.addEventListener("input", renderReportPreview);

    const cn = document.getElementById("c_name");
    const cl = document.getElementById("c_list");
    cn && cn.addEventListener("input", renderReportPreview);
    cl && cl.addEventListener("input", renderReportPreview);

    const go = document.getElementById("btnGoReport");
    go && go.addEventListener("click", ()=> setTab("reporte"));
  }
})();
</script>
</body>
</html>
